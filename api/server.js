"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const express = require("express");
var app = express();
const ConnectionPool = require("tedious-connection-pool");
const tds = require("./app/utils/tds-promises");
const passport = require("passport");
var BasicStrategy = require('passport-http').BasicStrategy;
var BearerStrategy = require('passport-azure-ad').BearerStrategy;
var bodyParser = require('body-parser');
var fs = require('fs');
var env = require('dotenv').load();
var moment = require('moment');
const kegController = require("./app/controllers/kegController");
const personController = require("./app/controllers/personController");
const sessionController = require("./app/controllers/session");
const votingController = require("./app/controllers/votingController");
const adminController = require("./app/controllers/adminController");
const updateController = require("./app/controllers/updateController");
const queryExpression = require("./app/utils/query_expression");
const adminUserCache = require("./app/utils/admin_user_cache");
const settings = require("./app/utils/settings_encoder");
require('./app/utils/array_async');
var config = {
    userName: process.env.SqlUsername,
    password: process.env.SqlPassword,
    server: process.env.SqlServer,
    options: {
        database: process.env.SqlDatabase,
        encrypt: true,
        rowCollectionOnRequestCompletion: true
    }
};
var basicAuthCreds = JSON.parse(process.env.Basic_Auth_Conn_String);
tds.default.setConnectionPool(new ConnectionPool({}, config));
app.use(bodyParser.urlencoded({ extended: true }));
app.use(bodyParser.json());
app.use(passport.initialize());
passport.use(new BasicStrategy((username, password, done) => __awaiter(this, void 0, void 0, function* () {
    try {
        for (var cred in basicAuthCreds) {
            if (username === basicAuthCreds[cred].username && password === basicAuthCreds[cred].key) {
                return done(null, true);
            }
        }
        return done(null, false, { message: 'Invalid client_id or api_key' });
    }
    catch (ex) {
        done(ex);
    }
})));
var aad_auth_options = {
    identityMetadata: process.env.AADMetadataEndpoint,
    clientID: process.env.ClientId,
    audience: settings.decodeSettingArray(process.env.AADAudience),
    validateIssuer: true,
};
passport.use("aad-user", new BearerStrategy(aad_auth_options, (token, done) => __awaiter(this, void 0, void 0, function* () {
    token['is_admin'] = yield adminUserCache.isUserAdmin(token.oid);
    return done(null, token);
})));
passport.use("aad-admin", new BearerStrategy(aad_auth_options, (token, done) => __awaiter(this, void 0, void 0, function* () {
    if (yield adminUserCache.isUserAdmin(token.oid)) {
        token['is_admin'] = true;
        return done(null, token);
    }
    done(null, false);
})));
var basicAuthStrategy = () => passport.authenticate(['basic', 'aad-user'], { session: false });
var bearerOAuthStrategy = (requireAdmin) => passport.authenticate(requireAdmin ? 'aad-admin' : 'aad-user', { session: false });
var port = process.env.PORT || 8080;
var router = express.Router();
router.use((req, res, next) => {
    res.header("Access-Control-Allow-Origin", "*");
    res.header("Access-Control-Allow-Methods", "GET, OPTIONS, POST, PUT");
    res.header("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, Accept, Cache-Control, Authorization");
    next();
});
var stdHandler = (handler) => {
    return (req, res) => {
        handler(req, resp => {
            if (resp.code == 200) {
                return res.json(resp.msg);
            }
            else {
                return res.send(resp.code, resp.msg);
            }
        });
    };
};
router.get('/', function (req, res) {
    res.json({ message: 'Welcome to DX Liquid Intelligence api!' });
});
router.route('/appConfiguration')
    .get(bearerOAuthStrategy(false), stdHandler((req, resultDispatcher) => resultDispatcher({
    code: 200,
    msg: {
        UntappdClientId: process.env.UntappdClientId,
        UntappdClientSecret: process.env.UntappdClientSecret
    }
})));
router.route('/isPersonValid/:card_id')
    .get(basicAuthStrategy(), stdHandler((req, resultDispatcher) => personController.getPersonByCardId(req.params.card_id, resultDispatcher)));
router.route('/validpeople/:card_id?')
    .get(basicAuthStrategy(), stdHandler((req, resultDispatcher) => personController.getValidPeople(req.params.card_id, resultDispatcher)));
router.route('/kegs')
    .get(basicAuthStrategy(), stdHandler((req, resultDispatcher) => kegController.getKeg(null, resultDispatcher)))
    .post(bearerOAuthStrategy(true), stdHandler((req, resultDispatcher) => kegController.postNewKeg(req.body, resultDispatcher)));
router.route('/activity/:sessionId?')
    .get(basicAuthStrategy(), stdHandler((req, resultDispatcher) => sessionController.getSessions(req.params.sessionId, new queryExpression.QueryExpression(req.query), resultDispatcher)))
    .post(basicAuthStrategy(), stdHandler((req, resultDispatcher) => sessionController.postNewSession(req.body, resultDispatcher)));
router.route('/CurrentKeg/:tap_id?')
    .get(basicAuthStrategy(), stdHandler((req, resultDispatcher) => kegController.getCurrentKeg(req.params.tap_id, resultDispatcher)))
    .put(bearerOAuthStrategy(true), stdHandler((req, resultDispatcher) => kegController.postPreviouslyInstalledKeg(req.body.KegId, req.params.tap_id, req.body.KegSize, resultDispatcher)));
router.route('/users/:user_id?')
    .get(bearerOAuthStrategy(false), stdHandler((req, resultDispatcher) => personController.getUserDetails(req.params.user_id, req.user.is_admin, req.user.upn, resultDispatcher)))
    .put(bearerOAuthStrategy(false), stdHandler((req, resultDispatcher) => personController.postUserDetails(req.params.user_id, req.user.is_admin, req.user.upn, req.body, resultDispatcher)));
router.route('/votes/:user_id')
    .get(bearerOAuthStrategy(false), stdHandler((req, resultDispatcher) => votingController.getUserVotes(req.params.user_id, resultDispatcher)))
    .put(bearerOAuthStrategy(false), stdHandler((req, resultDispatcher) => votingController.putUserVotes(req.params.user_id, req.body, resultDispatcher)));
router.route('/votes_tally')
    .get(bearerOAuthStrategy(false), stdHandler((req, resultDispatcher) => votingController.getVotesTally(resultDispatcher)));
router.route('/admin/AuthorizedGroups')
    .get(bearerOAuthStrategy(true), stdHandler((req, resultDispatcher) => adminController.getAllowedGroups(req.query, resultDispatcher)))
    .put(bearerOAuthStrategy(true), stdHandler((req, resultDispatcher) => adminController.putAllowedGroups(req.body.AuthorizedGroups, req.headers.authorization, resultDispatcher)));
router.route('/updates/:package_type')
    .get(basicAuthStrategy(), stdHandler((req, resultDispatcher) => updateController.getAvailableUpdates(req.params.package_type, new queryExpression.QueryExpression(req.query), resultDispatcher)));
app.use('/api', router);
app.listen(port, function () {
    console.log('Listening on port: ' + port);
});
module.exports = { app };

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LENBQUMsQ0FBQztBQUM5QyxDQUFDLENBQUMsQ0FBQztBQUVILE1BQU0sQ0FBQyxPQUFPLEdBQUcsRUFBQyxHQUFHLEVBQUMsQ0FBQyIsImZpbGUiOiJzZXJ2ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwidHlwaW5ncy9pbmRleC5kLnRzXCIgLz5cclxuXHJcbmltcG9ydCBleHByZXNzID0gcmVxdWlyZSgnZXhwcmVzcycpOyAgICAgICAgLy8gY2FsbCBleHByZXNzXHJcbnZhciBhcHAgPSBleHByZXNzKCk7ICAgICAgICAgICAgICAgICAvLyBkZWZpbmUgb3VyIGFwcCB1c2luZyBleHByZXNzXHJcblxyXG5pbXBvcnQgQ29ubmVjdGlvblBvb2wgPSByZXF1aXJlKCd0ZWRpb3VzLWNvbm5lY3Rpb24tcG9vbCcpO1xyXG5pbXBvcnQgdGRzID0gcmVxdWlyZSgnLi9hcHAvdXRpbHMvdGRzLXByb21pc2VzJyk7XHJcbmltcG9ydCB7VFlQRVN9IGZyb20gJ3RlZGlvdXMnO1xyXG5pbXBvcnQgcGFzc3BvcnQgPSByZXF1aXJlKCdwYXNzcG9ydCcpO1xyXG52YXIgQmFzaWNTdHJhdGVneSA9IHJlcXVpcmUoJ3Bhc3Nwb3J0LWh0dHAnKS5CYXNpY1N0cmF0ZWd5O1xyXG52YXIgQmVhcmVyU3RyYXRlZ3kgPSByZXF1aXJlKCdwYXNzcG9ydC1henVyZS1hZCcpLkJlYXJlclN0cmF0ZWd5O1xyXG52YXIgYm9keVBhcnNlciA9IHJlcXVpcmUoJ2JvZHktcGFyc2VyJyk7XHJcbnZhciBmcyA9IHJlcXVpcmUoJ2ZzJyk7IC8vRm9yIFNTTFxyXG52YXIgZW52ID0gcmVxdWlyZSgnZG90ZW52JykubG9hZCgpO1xyXG52YXIgbW9tZW50ID0gcmVxdWlyZSgnbW9tZW50Jyk7XHJcbmltcG9ydCBrZWdDb250cm9sbGVyID0gcmVxdWlyZSgnLi9hcHAvY29udHJvbGxlcnMva2VnQ29udHJvbGxlcicpO1xyXG5pbXBvcnQgcGVyc29uQ29udHJvbGxlciA9IHJlcXVpcmUoJy4vYXBwL2NvbnRyb2xsZXJzL3BlcnNvbkNvbnRyb2xsZXInKTtcclxuaW1wb3J0IHNlc3Npb25Db250cm9sbGVyID0gcmVxdWlyZSgnLi9hcHAvY29udHJvbGxlcnMvc2Vzc2lvbicpO1xyXG5pbXBvcnQgdm90aW5nQ29udHJvbGxlciA9IHJlcXVpcmUoJy4vYXBwL2NvbnRyb2xsZXJzL3ZvdGluZ0NvbnRyb2xsZXInKTtcclxuaW1wb3J0IGFkbWluQ29udHJvbGxlciA9IHJlcXVpcmUoJy4vYXBwL2NvbnRyb2xsZXJzL2FkbWluQ29udHJvbGxlcicpO1xyXG5pbXBvcnQgdXBkYXRlQ29udHJvbGxlciA9IHJlcXVpcmUoJy4vYXBwL2NvbnRyb2xsZXJzL3VwZGF0ZUNvbnRyb2xsZXInKTtcclxuaW1wb3J0IHF1ZXJ5RXhwcmVzc2lvbiA9IHJlcXVpcmUoJy4vYXBwL3V0aWxzL3F1ZXJ5X2V4cHJlc3Npb24nKTtcclxuaW1wb3J0IGFkbWluVXNlckNhY2hlID0gcmVxdWlyZSgnLi9hcHAvdXRpbHMvYWRtaW5fdXNlcl9jYWNoZScpO1xyXG5pbXBvcnQgc2V0dGluZ3MgPSByZXF1aXJlKCcuL2FwcC91dGlscy9zZXR0aW5nc19lbmNvZGVyJyk7XHJcbnJlcXVpcmUoJy4vYXBwL3V0aWxzL2FycmF5X2FzeW5jJyk7XHJcblxyXG52YXLCoGNvbmZpZ8KgPcKge1xyXG7CoMKgwqDCoHVzZXJOYW1lOsKgcHJvY2Vzcy5lbnYuU3FsVXNlcm5hbWUsXHJcbsKgwqDCoMKgcGFzc3dvcmQ6wqBwcm9jZXNzLmVudi5TcWxQYXNzd29yZCxcclxuwqDCoMKgwqBzZXJ2ZXI6wqBwcm9jZXNzLmVudi5TcWxTZXJ2ZXIsXHJcbsKgwqDCoMKgb3B0aW9uczrCoHtcclxuICAgICAgICBkYXRhYmFzZTogcHJvY2Vzcy5lbnYuU3FsRGF0YWJhc2UsXHJcbsKgwqDCoMKgwqDCoMKgwqBlbmNyeXB0OsKgdHJ1ZSxcclxuICAgICAgICByb3dDb2xsZWN0aW9uT25SZXF1ZXN0Q29tcGxldGlvbjogdHJ1ZVxyXG7CoMKgwqDCoH1cclxufTtcclxuXHJcbnZhciBiYXNpY0F1dGhDcmVkcyA9IEpTT04ucGFyc2UocHJvY2Vzcy5lbnYuQmFzaWNfQXV0aF9Db25uX1N0cmluZyk7XHJcblxyXG50ZHMuZGVmYXVsdC5zZXRDb25uZWN0aW9uUG9vbChuZXcgQ29ubmVjdGlvblBvb2woe30sIGNvbmZpZykpO1xyXG5cclxuYXBwLnVzZShib2R5UGFyc2VyLnVybGVuY29kZWQoeyBleHRlbmRlZDogdHJ1ZSB9KSk7XHJcbmFwcC51c2UoYm9keVBhcnNlci5qc29uKCkpO1xyXG5cclxuLyogQXp1cmUgQUQgKi9cclxuYXBwLnVzZShwYXNzcG9ydC5pbml0aWFsaXplKCkpO1xyXG5cclxucGFzc3BvcnQudXNlKG5ldyBCYXNpY1N0cmF0ZWd5KGFzeW5jICh1c2VybmFtZSwgcGFzc3dvcmQsIGRvbmUpID0+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgZm9yKHZhciBjcmVkIGluIGJhc2ljQXV0aENyZWRzKXtcclxuICAgICAgICAgICAgaWYodXNlcm5hbWUgPT09IGJhc2ljQXV0aENyZWRzW2NyZWRdLnVzZXJuYW1lICYmIHBhc3N3b3JkID09PSBiYXNpY0F1dGhDcmVkc1tjcmVkXS5rZXkpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGRvbmUobnVsbCwgdHJ1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9ICBcclxuICAgICAgICByZXR1cm4gZG9uZShudWxsLCBmYWxzZSwge21lc3NhZ2U6ICdJbnZhbGlkIGNsaWVudF9pZCBvciBhcGlfa2V5J30pO1xyXG4gICAgfVxyXG4gICAgY2F0Y2ggKGV4KSB7XHJcbiAgICAgICAgZG9uZShleCk7XHJcbiAgICB9XHJcbn0pKTtcclxuLy8gT0F1dGggYmVhcmVyIHN0cmF0ZWd5IGZvciBhZG1pbiBhcGlzXHJcbnZhciBhYWRfYXV0aF9vcHRpb25zID0geyAgXHJcbiAgICBpZGVudGl0eU1ldGFkYXRhOiBwcm9jZXNzLmVudi5BQURNZXRhZGF0YUVuZHBvaW50LFxyXG4gICAgY2xpZW50SUQ6IHByb2Nlc3MuZW52LkNsaWVudElkLCAgXHJcbiAgICBhdWRpZW5jZTogc2V0dGluZ3MuZGVjb2RlU2V0dGluZ0FycmF5KHByb2Nlc3MuZW52LkFBREF1ZGllbmNlKSwgIFxyXG4gICAgdmFsaWRhdGVJc3N1ZXI6IHRydWUsICBcclxufTtcclxuLy8gU3RyYXRlZ3kgZm9yIGFueSB2YWxpZCBBQUQgdXNlclxyXG5wYXNzcG9ydC51c2UoXCJhYWQtdXNlclwiLCBuZXcgQmVhcmVyU3RyYXRlZ3koYWFkX2F1dGhfb3B0aW9ucywgYXN5bmMgKHRva2VuLCBkb25lKSA9PiB7IFxyXG4gICAgdG9rZW5bJ2lzX2FkbWluJ10gPSBhd2FpdCBhZG1pblVzZXJDYWNoZS5pc1VzZXJBZG1pbih0b2tlbi5vaWQpO1xyXG4gICAgcmV0dXJuIGRvbmUobnVsbCwgdG9rZW4pO1xyXG59KSk7XHJcbi8vIFN0cmF0ZWd5IGZvciB2YWxpZCBBQUQgdXNlcnMgaW4gb3VyIGFkbWluIGdyb3VwXHJcbnBhc3Nwb3J0LnVzZShcImFhZC1hZG1pblwiLCBuZXcgQmVhcmVyU3RyYXRlZ3koYWFkX2F1dGhfb3B0aW9ucywgYXN5bmMgKHRva2VuLCBkb25lKSA9PiB7IFxyXG4gICAgLy8gVmVyaWZ5IHRoYXQgdGhlIHVzZXIgYXNzb2NpYXRlZCB3aXRoIHRoZSBzdXBwbGllZCB0b2tlbiBpcyBhIG1lbWJlciBvZiBvdXIgc3BlY2lmaWVkIGdyb3VwXHJcbiAgICBpZiAoYXdhaXQgYWRtaW5Vc2VyQ2FjaGUuaXNVc2VyQWRtaW4odG9rZW4ub2lkKSkge1xyXG4gICAgICAgIHRva2VuWydpc19hZG1pbiddID0gdHJ1ZTtcclxuICAgICAgICByZXR1cm4gZG9uZShudWxsLCB0b2tlbik7XHJcbiAgICB9XHJcbiAgICBkb25lKG51bGwsIGZhbHNlKTtcclxufSkpO1xyXG4vLyBOb3RlOiBBbGwgcm91dGVzIHdpdGggJ2Jhc2ljJyBhdXRoIGFsc28gYWNjZXB0IE9BdXRoIGJlYXJlciBhcyB3ZWxsXHJcbnZhciBiYXNpY0F1dGhTdHJhdGVneSA9ICgpID0+IHBhc3Nwb3J0LmF1dGhlbnRpY2F0ZShbJ2Jhc2ljJywgJ2FhZC11c2VyJ10sIHtzZXNzaW9uOiBmYWxzZX0pO1xyXG52YXIgYmVhcmVyT0F1dGhTdHJhdGVneSA9IChyZXF1aXJlQWRtaW46IGJvb2xlYW4pID0+IHBhc3Nwb3J0LmF1dGhlbnRpY2F0ZShyZXF1aXJlQWRtaW4gPyAnYWFkLWFkbWluJyA6ICdhYWQtdXNlcicsIHtzZXNzaW9uOiBmYWxzZX0pO1xyXG5cclxuLyogU2V0dGluZyBQb3J0IHRvIDgwMDAgKi9cclxudmFyIHBvcnQgPSBwcm9jZXNzLmVudi5QT1JUIHx8IDgwODA7XHJcbnZhciByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xyXG5cclxucm91dGVyLnVzZSgocmVxLCByZXMsIG5leHQpID0+IHtcclxuICAgIHJlcy5oZWFkZXIoXCJBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW5cIiwgXCIqXCIpO1xyXG4gICAgcmVzLmhlYWRlcihcIkFjY2Vzcy1Db250cm9sLUFsbG93LU1ldGhvZHNcIiwgXCJHRVQsIE9QVElPTlMsIFBPU1QsIFBVVFwiKTtcclxuICAgIHJlcy5oZWFkZXIoXCJBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzXCIsIFwiT3JpZ2luLCBYLVJlcXVlc3RlZC1XaXRoLCBDb250ZW50LVR5cGUsIEFjY2VwdCwgQ2FjaGUtQ29udHJvbCwgQXV0aG9yaXphdGlvblwiKTtcclxuICAgIG5leHQoKTtcclxufSk7XHJcblxyXG52YXIgc3RkSGFuZGxlciA9IChoYW5kbGVyOiAocmVxOmV4cHJlc3MuUmVxdWVzdCwgcmVzdWx0RGlzcGF0Y2hlcjoocmVzcDphbnkpPT5leHByZXNzLlJlc3BvbnNlKT0+dm9pZCkgPT4ge1xyXG4gICAgcmV0dXJuIChyZXE6ZXhwcmVzcy5SZXF1ZXN0LCByZXM6ZXhwcmVzcy5SZXNwb25zZSkgPT4ge1xyXG4gICAgICAgIGhhbmRsZXIocmVxLCByZXNwID0+IHtcclxuICAgICAgICAgICAgaWYgKHJlc3AuY29kZSA9PSAyMDApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXMuanNvbihyZXNwLm1zZyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzLnNlbmQocmVzcC5jb2RlLCByZXNwLm1zZyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH07XHJcbn07XHJcblxyXG5yb3V0ZXIuZ2V0KCcvJywgZnVuY3Rpb24ocmVxLCByZXMpIHtcclxuICAgIHJlcy5qc29uKHsgbWVzc2FnZTogJ1dlbGNvbWUgdG8gRFggTGlxdWlkIEludGVsbGlnZW5jZSBhcGkhJyB9KTsgICBcclxufSk7XHJcblxyXG5yb3V0ZXIucm91dGUoJy9hcHBDb25maWd1cmF0aW9uJylcclxuICAgIC5nZXQoYmVhcmVyT0F1dGhTdHJhdGVneShmYWxzZSksIHN0ZEhhbmRsZXIoKHJlcSwgcmVzdWx0RGlzcGF0Y2hlcikgPT4gcmVzdWx0RGlzcGF0Y2hlcih7XHJcbiAgICAgICAgY29kZTogMjAwLCBcclxuICAgICAgICBtc2c6IHtcclxuICAgICAgICAgICAgVW50YXBwZENsaWVudElkOiBwcm9jZXNzLmVudi5VbnRhcHBkQ2xpZW50SWQsXHJcbiAgICAgICAgICAgIFVudGFwcGRDbGllbnRTZWNyZXQ6IHByb2Nlc3MuZW52LlVudGFwcGRDbGllbnRTZWNyZXRcclxuICAgICAgICB9XHJcbiAgICB9KSkpO1xyXG5cclxucm91dGVyLnJvdXRlKCcvaXNQZXJzb25WYWxpZC86Y2FyZF9pZCcpXHJcbiAgICAuZ2V0KGJhc2ljQXV0aFN0cmF0ZWd5KCksIHN0ZEhhbmRsZXIoKHJlcSwgcmVzdWx0RGlzcGF0Y2hlcikgPT4gcGVyc29uQ29udHJvbGxlci5nZXRQZXJzb25CeUNhcmRJZChyZXEucGFyYW1zLmNhcmRfaWQsIHJlc3VsdERpc3BhdGNoZXIpKSk7XHJcblxyXG5yb3V0ZXIucm91dGUoJy92YWxpZHBlb3BsZS86Y2FyZF9pZD8nKVxyXG4gICAgLmdldChiYXNpY0F1dGhTdHJhdGVneSgpLCBzdGRIYW5kbGVyKChyZXEsIHJlc3VsdERpc3BhdGNoZXIpID0+IHBlcnNvbkNvbnRyb2xsZXIuZ2V0VmFsaWRQZW9wbGUocmVxLnBhcmFtcy5jYXJkX2lkLCByZXN1bHREaXNwYXRjaGVyKSkpO1xyXG5cclxucm91dGVyLnJvdXRlKCcva2VncycpXHJcbiAgICAuZ2V0KGJhc2ljQXV0aFN0cmF0ZWd5KCksIHN0ZEhhbmRsZXIoKHJlcSwgcmVzdWx0RGlzcGF0Y2hlcikgPT4ga2VnQ29udHJvbGxlci5nZXRLZWcobnVsbCwgcmVzdWx0RGlzcGF0Y2hlcikpKVxyXG4gICAgLnBvc3QoYmVhcmVyT0F1dGhTdHJhdGVneSh0cnVlKSwgc3RkSGFuZGxlcigocmVxLCByZXN1bHREaXNwYXRjaGVyKSA9PiBrZWdDb250cm9sbGVyLnBvc3ROZXdLZWcocmVxLmJvZHksIHJlc3VsdERpc3BhdGNoZXIpKSk7XHJcblxyXG5yb3V0ZXIucm91dGUoJy9hY3Rpdml0eS86c2Vzc2lvbklkPycpXHJcbiAgICAuZ2V0KGJhc2ljQXV0aFN0cmF0ZWd5KCksIHN0ZEhhbmRsZXIoKHJlcSwgcmVzdWx0RGlzcGF0Y2hlcikgPT4gc2Vzc2lvbkNvbnRyb2xsZXIuZ2V0U2Vzc2lvbnMocmVxLnBhcmFtcy5zZXNzaW9uSWQsIG5ldyBxdWVyeUV4cHJlc3Npb24uUXVlcnlFeHByZXNzaW9uKHJlcS5xdWVyeSksIHJlc3VsdERpc3BhdGNoZXIpKSlcclxuICAgIC5wb3N0KGJhc2ljQXV0aFN0cmF0ZWd5KCksIHN0ZEhhbmRsZXIoKHJlcSwgcmVzdWx0RGlzcGF0Y2hlcikgPT4gc2Vzc2lvbkNvbnRyb2xsZXIucG9zdE5ld1Nlc3Npb24ocmVxLmJvZHksIHJlc3VsdERpc3BhdGNoZXIpKSk7XHJcblxyXG5yb3V0ZXIucm91dGUoJy9DdXJyZW50S2VnLzp0YXBfaWQ/JylcclxuICAgIC5nZXQoYmFzaWNBdXRoU3RyYXRlZ3koKSwgc3RkSGFuZGxlcigocmVxLCByZXN1bHREaXNwYXRjaGVyKSA9PiBrZWdDb250cm9sbGVyLmdldEN1cnJlbnRLZWcocmVxLnBhcmFtcy50YXBfaWQsIHJlc3VsdERpc3BhdGNoZXIpKSlcclxuICAgIC5wdXQoYmVhcmVyT0F1dGhTdHJhdGVneSh0cnVlKSwgc3RkSGFuZGxlcigocmVxLCByZXN1bHREaXNwYXRjaGVyKSA9PiBrZWdDb250cm9sbGVyLnBvc3RQcmV2aW91c2x5SW5zdGFsbGVkS2VnKHJlcS5ib2R5LktlZ0lkLCByZXEucGFyYW1zLnRhcF9pZCwgcmVxLmJvZHkuS2VnU2l6ZSwgcmVzdWx0RGlzcGF0Y2hlcikpKTtcclxuXHJcbnJvdXRlci5yb3V0ZSgnL3VzZXJzLzp1c2VyX2lkPycpXHJcbiAgICAuZ2V0KGJlYXJlck9BdXRoU3RyYXRlZ3koZmFsc2UpLCBzdGRIYW5kbGVyKChyZXEsIHJlc3VsdERpc3BhdGNoZXIpID0+IHBlcnNvbkNvbnRyb2xsZXIuZ2V0VXNlckRldGFpbHMocmVxLnBhcmFtcy51c2VyX2lkLCByZXEudXNlci5pc19hZG1pbiwgcmVxLnVzZXIudXBuLCByZXN1bHREaXNwYXRjaGVyKSkpXHJcbiAgICAucHV0KGJlYXJlck9BdXRoU3RyYXRlZ3koZmFsc2UpLCBzdGRIYW5kbGVyKChyZXEsIHJlc3VsdERpc3BhdGNoZXIpID0+IHBlcnNvbkNvbnRyb2xsZXIucG9zdFVzZXJEZXRhaWxzKHJlcS5wYXJhbXMudXNlcl9pZCwgcmVxLnVzZXIuaXNfYWRtaW4sIHJlcS51c2VyLnVwbiwgcmVxLmJvZHksIHJlc3VsdERpc3BhdGNoZXIpKSk7XHJcblxyXG5yb3V0ZXIucm91dGUoJy92b3Rlcy86dXNlcl9pZCcpXHJcbiAgICAuZ2V0KGJlYXJlck9BdXRoU3RyYXRlZ3koZmFsc2UpLCBzdGRIYW5kbGVyKChyZXEsIHJlc3VsdERpc3BhdGNoZXIpID0+IHZvdGluZ0NvbnRyb2xsZXIuZ2V0VXNlclZvdGVzKHJlcS5wYXJhbXMudXNlcl9pZCwgcmVzdWx0RGlzcGF0Y2hlcikpKVxyXG4gICAgLnB1dChiZWFyZXJPQXV0aFN0cmF0ZWd5KGZhbHNlKSwgc3RkSGFuZGxlcigocmVxLCByZXN1bHREaXNwYXRjaGVyKSA9PiB2b3RpbmdDb250cm9sbGVyLnB1dFVzZXJWb3RlcyhyZXEucGFyYW1zLnVzZXJfaWQsIHJlcS5ib2R5LCByZXN1bHREaXNwYXRjaGVyKSkpO1xyXG5cclxucm91dGVyLnJvdXRlKCcvdm90ZXNfdGFsbHknKVxyXG4gICAgLmdldChiZWFyZXJPQXV0aFN0cmF0ZWd5KGZhbHNlKSwgc3RkSGFuZGxlcigocmVxLCByZXN1bHREaXNwYXRjaGVyKSA9PiB2b3RpbmdDb250cm9sbGVyLmdldFZvdGVzVGFsbHkocmVzdWx0RGlzcGF0Y2hlcikpKVxyXG5cclxucm91dGVyLnJvdXRlKCcvYWRtaW4vQXV0aG9yaXplZEdyb3VwcycpXHJcbiAgICAuZ2V0KGJlYXJlck9BdXRoU3RyYXRlZ3kodHJ1ZSksIHN0ZEhhbmRsZXIoKHJlcSwgcmVzdWx0RGlzcGF0Y2hlcikgPT4gYWRtaW5Db250cm9sbGVyLmdldEFsbG93ZWRHcm91cHMocmVxLnF1ZXJ5LCByZXN1bHREaXNwYXRjaGVyKSkpXHJcbiAgICAucHV0KGJlYXJlck9BdXRoU3RyYXRlZ3kodHJ1ZSksIHN0ZEhhbmRsZXIoKHJlcSwgcmVzdWx0RGlzcGF0Y2hlcikgPT4gYWRtaW5Db250cm9sbGVyLnB1dEFsbG93ZWRHcm91cHMocmVxLmJvZHkuQXV0aG9yaXplZEdyb3VwcywgcmVxLmhlYWRlcnMuYXV0aG9yaXphdGlvbiwgcmVzdWx0RGlzcGF0Y2hlcikpKTtcclxuXHJcbnJvdXRlci5yb3V0ZSgnL3VwZGF0ZXMvOnBhY2thZ2VfdHlwZScpXHJcbiAgICAuZ2V0KGJhc2ljQXV0aFN0cmF0ZWd5KCksIHN0ZEhhbmRsZXIoKHJlcSwgcmVzdWx0RGlzcGF0Y2hlcikgPT4gdXBkYXRlQ29udHJvbGxlci5nZXRBdmFpbGFibGVVcGRhdGVzKHJlcS5wYXJhbXMucGFja2FnZV90eXBlLCBuZXcgcXVlcnlFeHByZXNzaW9uLlF1ZXJ5RXhwcmVzc2lvbihyZXEucXVlcnkpLCByZXN1bHREaXNwYXRjaGVyKSkpO1xyXG5cclxuYXBwLnVzZSgnL2FwaScsIHJvdXRlcik7XHJcblxyXG5hcHAubGlzdGVuKHBvcnQsIGZ1bmN0aW9uICgpIHtcclxuICAgIGNvbnNvbGUubG9nKCdMaXN0ZW5pbmcgb24gcG9ydDogJyArIHBvcnQpO1xyXG59KTtcclxuXHJcbm1vZHVsZS5leHBvcnRzID0ge2FwcH07XHJcbiJdfQ==
