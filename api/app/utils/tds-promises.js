"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const tedious = require("tedious");
const _ = require("lodash");
_.mixin(require('lodash-deep'));
class TdsPromises {
    setConnectionPool(connectionPool) {
        if (!connectionPool || !_.isFunction(connectionPool.acquire)) {
            throw new Error('Connection pool parameter required.');
        }
        TdsPromises._connectionPool = connectionPool;
        TdsPromises._connectionPool.on('error', (err) => {
            console.error('TdsPromises connection pool error: ' + err);
            return 0;
        });
        return this;
    }
    sql(sqlStatement) {
        return new TdsConnection().sql(sqlStatement);
    }
}
;
exports.default = new TdsPromises();
class TdsConnection {
    constructor() {
    }
    open() {
        if (!this._openPromise) {
            this._openPromise = new Promise((resolve, reject) => {
                TdsPromises._connectionPool.acquire((err, connection) => {
                    try {
                        if (err) {
                            if (connection) {
                                connection.release();
                            }
                            reject(err);
                        }
                        else {
                            this._connection = connection;
                            resolve();
                        }
                    }
                    catch (ex) {
                        reject(ex);
                    }
                });
            });
        }
        return this._openPromise;
    }
    close() {
        if (this._connection) {
            this._connection.release();
            this._connection = null;
            this._openPromise = null;
        }
    }
    get connection() {
        return this._connection;
    }
    connectionAsync() {
        return __awaiter(this, void 0, void 0, function* () {
            yield this.open();
            return this._connection;
        });
    }
    sql(sqlStatement) {
        return new TdsStatement(this, sqlStatement);
    }
    beginTransaction() {
        if (!this._connection) {
            throw new Error('Connection has not been established. Call open() first');
        }
        else if (this._inTransaction) {
            throw new Error('Transaction already started. Nested transactions are not supported');
        }
        return new Promise((resolve, reject) => {
            this._connection.beginTransaction((err) => {
                if (err) {
                    reject(err);
                }
                else {
                    this._inTransaction = true;
                    resolve();
                }
            });
        });
    }
    commitTransaction() {
        if (!this._inTransaction) {
            throw new Error('Transaction is not active. Call beginTransaction() frist');
        }
        return new Promise((resolve, reject) => {
            this._connection.commitTransaction((err) => {
                if (err) {
                    reject(err);
                }
                else {
                    this._inTransaction = false;
                    resolve();
                }
            });
        });
    }
    rollbackTransaction() {
        if (!this._inTransaction) {
            throw new Error('Transaction is not active. Call beginTransaction() frist');
        }
        return new Promise((resolve, reject) => {
            this._connection.rollbackTransaction((err) => {
                if (err) {
                    reject(err);
                }
                else {
                    this._inTransaction = false;
                    resolve();
                }
            });
        });
    }
    transaction(transactionBody, postCommit, error) {
        return __awaiter(this, void 0, void 0, function* () {
            var inXact = false;
            try {
                yield this.open();
                yield this.beginTransaction();
                inXact = true;
                var results = yield transactionBody(this);
                yield this.commitTransaction();
                inXact = false;
                if (postCommit) {
                    postCommit(results);
                }
            }
            catch (ex) {
                try {
                    if (inXact) {
                        yield this.rollbackTransaction();
                    }
                }
                catch (ex2) { }
                if (error) {
                    error(ex);
                }
            }
            finally {
                this.close();
            }
        });
    }
}
exports.TdsConnection = TdsConnection;
class BindablePromise {
    constructor() {
        this.reset();
    }
    get promise() {
        return this._promise;
    }
    resolve(value) {
        this._resolve(value);
    }
    reject(reason) {
        this._reject(reason);
    }
    reset() {
        this._promise = new Promise((resolve, reject) => {
            this._resolve = resolve;
            this._reject = reject;
        });
    }
}
class TdsStatement {
    constructor(connection, sqlStatement) {
        this._columns = {};
        this._connection = connection;
        this._promise = new BindablePromise();
        this._request = new tedious.Request(sqlStatement, (err, rowCount, rows) => {
            if (err) {
                this._promise.reject(err);
            }
            else {
                this._promise.resolve(rows.map(row => {
                    return this._transformRow(row);
                }));
            }
        });
    }
    parameter(name, type, value, options) {
        this._request.addParameter(name, type, value, options);
        return this;
    }
    prepare() {
        return __awaiter(this, void 0, void 0, function* () {
            var openConnection = yield this._connection.connectionAsync();
            return new Promise((resolve, reject) => {
                openConnection.prepare(this._request);
                this._request.on('prepared', () => {
                    resolve(this);
                });
            });
        });
    }
    executeImmediate() {
        return this.execute(true, false, null);
    }
    execute(releaseConnection, callSproc = false, parameters) {
        return new Promise((resolve, reject) => __awaiter(this, void 0, void 0, function* () {
            try {
                this._promise.reset();
                var openConnection = yield this._connection.connectionAsync();
                if (callSproc) {
                    openConnection.callProcedure(this._request);
                }
                else if (parameters) {
                    openConnection.execute(this._request, parameters);
                }
                else {
                    openConnection.execSql(this._request);
                }
                let results = yield this._promise.promise;
                resolve(results);
            }
            catch (ex) {
                reject(ex);
            }
        }))
            .then((value) => {
            if (releaseConnection) {
                this._connection.close();
            }
            return value;
        })
            .catch((reason) => {
            if (releaseConnection) {
                this._connection.close();
            }
            return Promise.reject(reason);
        });
    }
    _transformRow(row) {
        var result = {};
        for (var i = 0; i < row.length; i++) {
            var col = row[i];
            var map = this._getColumnMap(col.metadata.colName);
            map.applyMapping(col, result);
        }
        return result;
    }
    _getColumnMap(colName) {
        var map = this._columns[colName];
        if (!map) {
            map = new TdsColumn(colName);
            this._columns[colName] = map;
        }
        return map;
    }
}
exports.TdsStatement = TdsStatement;
class TdsColumn {
    constructor(name) {
        this.name = name;
        this._getColumnValue = (column) => { return column.value; };
        this._applyMapping = (column, result) => {
            var value = this._getColumnValue(column);
            result[this.name] = value;
        };
    }
    applyMapping(column, result) {
        this._applyMapping(column, result);
    }
    overrideGetValue(getFunction) {
        this._getColumnValue = getFunction;
        return this;
    }
    ;
    overrideApplyMapping(applyFunction) {
        this._applyMapping = applyFunction;
        return this;
    }
    ;
    asBoolean() {
        return this.overrideGetValue((column) => {
            if (column.value === undefined || column.value === null) {
                return null;
            }
            if (_.isFinite(column.value)) {
                return column.value !== 0;
            }
            if (_.isString(column.value)) {
                var str = column.value.toUpperCase();
                if (str === 'TRUE' || str === 'T' || str === 'Y' || str === 'YES' || str === '1') {
                    return true;
                }
                if (str === 'FALSE' || str === 'F' || str === 'N' || str === 'NO' || str === '0') {
                    return false;
                }
            }
            throw new Error('Unable to convert "' + column.value + '" to a boolean.');
        });
    }
    ;
    asDate() {
        return this.overrideGetValue((column) => {
            if (column.value === undefined || column.value === null) {
                return null;
            }
            if (_.isFinite(column.value)) {
                return new Date(column.value);
            }
            return Date.parse(column.value);
        });
    }
    ;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC91dGlscy90ZHMtcHJvbWlzZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUNBLG1DQUFvQztBQUVwQyw0QkFBNkI7QUFDN0IsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztBQUVoQztJQUdJLGlCQUFpQixDQUFDLGNBQThCO1FBRTVDLEVBQUUsQ0FBQyxDQUFDLENBQUMsY0FBYyxJQUFJLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzNELE1BQU0sSUFBSSxLQUFLLENBQUMscUNBQXFDLENBQUMsQ0FBQztRQUMzRCxDQUFDO1FBRUQsV0FBVyxDQUFDLGVBQWUsR0FBRyxjQUFjLENBQUM7UUFDN0MsV0FBVyxDQUFDLGVBQWUsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsR0FBRztZQUl4QyxPQUFPLENBQUMsS0FBSyxDQUFDLHFDQUFxQyxHQUFHLEdBQUcsQ0FBQyxDQUFDO1lBQzNELE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDYixDQUFDLENBQUMsQ0FBQTtRQUNGLE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVELEdBQUcsQ0FBQyxZQUFvQjtRQUNwQixNQUFNLENBQUMsSUFBSSxhQUFhLEVBQUUsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDakQsQ0FBQztDQUNKO0FBQUEsQ0FBQztBQUNGLGtCQUFlLElBQUksV0FBVyxFQUFFLENBQUM7QUFFakM7SUFLSTtJQUNBLENBQUM7SUFFRCxJQUFJO1FBQ0EsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztZQUNyQixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksT0FBTyxDQUFPLENBQUMsT0FBTyxFQUFFLE1BQU07Z0JBQ2xELFdBQVcsQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUMs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QyxLQUFLLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDdEQsTUFBTSxDQUFDLElBQUksQ0FBQztZQUNoQixDQUFDO1lBQ0QsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUMzQixNQUFNLENBQUMsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2xDLENBQUM7WUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDcEMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBQUEsQ0FBQztDQUNMIiwiZmlsZSI6ImFwcC91dGlscy90ZHMtcHJvbWlzZXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcclxuaW1wb3J0IHRlZGlvdXMgPSByZXF1aXJlKCd0ZWRpb3VzJyk7XHJcbmltcG9ydCBDb25uZWN0aW9uUG9vbCA9IHJlcXVpcmUoJ3RlZGlvdXMtY29ubmVjdGlvbi1wb29sJyk7XHJcbmltcG9ydCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XHJcbl8ubWl4aW4ocmVxdWlyZSgnbG9kYXNoLWRlZXAnKSk7XHJcblxyXG5jbGFzcyBUZHNQcm9taXNlcyB7XHJcbiAgICBzdGF0aWMgX2Nvbm5lY3Rpb25Qb29sOiBDb25uZWN0aW9uUG9vbDtcclxuXHJcbiAgICBzZXRDb25uZWN0aW9uUG9vbChjb25uZWN0aW9uUG9vbDogQ29ubmVjdGlvblBvb2wpOiBUZHNQcm9taXNlcyB7XHJcblxyXG4gICAgICAgIGlmICghY29ubmVjdGlvblBvb2wgfHwgIV8uaXNGdW5jdGlvbihjb25uZWN0aW9uUG9vbC5hY3F1aXJlKSkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nvbm5lY3Rpb24gcG9vbCBwYXJhbWV0ZXIgcmVxdWlyZWQuJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBUZHNQcm9taXNlcy5fY29ubmVjdGlvblBvb2wgPSBjb25uZWN0aW9uUG9vbDtcclxuICAgICAgICBUZHNQcm9taXNlcy5fY29ubmVjdGlvblBvb2wub24oJ2Vycm9yJywgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAvLyBXZSBwcmltYXJpbHkgbmVlZCB0byBoYW5kbGUgdGhpcyBldmVudCB0byBwcmV2ZW50IHRoZSBlcnJvciBidWJibGluZyB1cCB0byBiZSBcclxuICAgICAgICAgICAgLy8gYW4gdW5oYW5kbGVkIGV4Y2VwdGlvbiAmIHRoZSBwcm9jZXNzIHRvIGNyYXNoLiBXZSBkb24ndCBuZWVkIHRvIGRvIGFueXRoaW5nIGhlcmVcclxuICAgICAgICAgICAgLy8gYXMgdGhlIGNvbm5lY3Rpb24gc2hvdWxkIHJlY292ZXIgaXRzZWxmLlxyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdUZHNQcm9taXNlcyBjb25uZWN0aW9uIHBvb2wgZXJyb3I6ICcgKyBlcnIpO1xyXG4gICAgICAgICAgICByZXR1cm4gMDtcclxuICAgICAgICB9KVxyXG4gICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgfVxyXG5cclxuICAgIHNxbChzcWxTdGF0ZW1lbnQ6IHN0cmluZyk6IFRkc1N0YXRlbWVudCB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBUZHNDb25uZWN0aW9uKCkuc3FsKHNxbFN0YXRlbWVudCk7XHJcbiAgICB9XHJcbn07XHJcbmV4cG9ydCBkZWZhdWx0IG5ldyBUZHNQcm9taXNlcygpO1xyXG5cclxuZXhwb3J0IGNsYXNzIFRkc0Nvbm5lY3Rpb24ge1xyXG4gICAgcHJpdmF0ZSBfY29ubmVjdGlvbjogQ29ubmVjdGlvblBvb2wuUG9vbGVkQ29ubmVjdGlvbjtcclxuICAgIHByaXZhdGUgX29wZW5Qcm9taXNlOiBQcm9taXNlPHZvaWQ+O1xyXG4gICAgcHJpdmF0ZSBfaW5UcmFuc2FjdGlvbjogYm9vbGVhbjtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgIH1cclxuXHJcbiAgICBvcGVuKCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIGlmICghdGhpcy5fb3BlblByb21pc2UpIHtcclxuICAgICAgICAgICAgdGhpcy5fb3BlblByb21pc2UgPSBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBUZHNQcm9taXNlcy5fY29ubmVjdGlvblBvb2wuYWNxdWlyZSgoZXJyOiBFcnJvciwgY29ubmVjdGlvbjogQ29ubmVjdGlvblBvb2wuUG9vbGVkQ29ubmVjdGlvbikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb25uZWN0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29ubmVjdGlvbi5yZWxlYXNlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBcclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jb25uZWN0aW9uID0gY29ubmVjdGlvbjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0gXHJcbiAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKGV4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChleCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5fb3BlblByb21pc2U7XHJcbiAgICB9XHJcblxyXG4gICAgY2xvc2UoKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMuX2Nvbm5lY3Rpb24pIHtcclxuICAgICAgICAgICAgdGhpcy5fY29ubmVjdGlvbi5yZWxlYXNlKCk7XHJcbiAgICAgICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24gPSBudWxsO1xyXG4gICAgICAgICAgICB0aGlzLl9vcGVuUHJvbWlzZSA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGdldCBjb25uZWN0aW9uKCk6IENvbm5lY3Rpb25Qb29sLlBvb2xlZENvbm5lY3Rpb24ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW9uO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIGNvbm5lY3Rpb25Bc3luYygpOiBQcm9taXNlPENvbm5lY3Rpb25Qb29sLlBvb2xlZENvbm5lY3Rpb24+IHtcclxuICAgICAgICBhd2FpdCB0aGlzLm9wZW4oKTtcclxuICAgICAgICByZXR1cm4gdGhpcy5fY29ubmVjdGlvbjtcclxuICAgIH1cclxuXHJcbiAgICBzcWwoc3FsU3RhdGVtZW50OiBzdHJpbmcpOiBUZHNTdGF0ZW1lbnQge1xyXG4gICAgICAgIHJldHVybiBuZXcgVGRzU3RhdGVtZW50KHRoaXMsIHNxbFN0YXRlbWVudCk7XHJcbiAgICB9XHJcblxyXG4gICAgYmVnaW5UcmFuc2FjdGlvbigpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICBpZiAoIXRoaXMuX2Nvbm5lY3Rpb24pIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb25uZWN0aW9uIGhhcyBub3QgYmVlbiBlc3RhYmxpc2hlZC4gQ2FsbCBvcGVuKCkgZmlyc3QnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAodGhpcy5faW5UcmFuc2FjdGlvbikge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RyYW5zYWN0aW9uIGFscmVhZHkgc3RhcnRlZC4gTmVzdGVkIHRyYW5zYWN0aW9ucyBhcmUgbm90IHN1cHBvcnRlZCcpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLl9jb25uZWN0aW9uLmJlZ2luVHJhbnNhY3Rpb24oKGVycjogRXJyb3IpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2luVHJhbnNhY3Rpb24gPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBjb21taXRUcmFuc2FjdGlvbigpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICBpZiAoIXRoaXMuX2luVHJhbnNhY3Rpb24pIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUcmFuc2FjdGlvbiBpcyBub3QgYWN0aXZlLiBDYWxsIGJlZ2luVHJhbnNhY3Rpb24oKSBmcmlzdCcpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLl9jb25uZWN0aW9uLmNvbW1pdFRyYW5zYWN0aW9uKChlcnI6IEVycm9yKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9pblRyYW5zYWN0aW9uID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICByb2xsYmFja1RyYW5zYWN0aW9uKCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIGlmICghdGhpcy5faW5UcmFuc2FjdGlvbikge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RyYW5zYWN0aW9uIGlzIG5vdCBhY3RpdmUuIENhbGwgYmVnaW5UcmFuc2FjdGlvbigpIGZyaXN0Jyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24ucm9sbGJhY2tUcmFuc2FjdGlvbigoZXJyOiBFcnJvcikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5faW5UcmFuc2FjdGlvbiA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgdHJhbnNhY3Rpb248VD4odHJhbnNhY3Rpb25Cb2R5OiAoY29ubmVjdGlvbjogVGRzQ29ubmVjdGlvbikgPT4gUHJvbWlzZTxUPiwgcG9zdENvbW1pdDogKFQpID0+IHZvaWQsIGVycm9yOiAoRXJyb3IpID0+IHZvaWQpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICB2YXIgaW5YYWN0ID0gZmFsc2U7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgYXdhaXQgdGhpcy5vcGVuKCk7XHJcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuYmVnaW5UcmFuc2FjdGlvbigpO1xyXG4gICAgICAgICAgICBpblhhY3QgPSB0cnVlO1xyXG4gICAgICAgICAgICB2YXIgcmVzdWx0cyA9IGF3YWl0IHRyYW5zYWN0aW9uQm9keSh0aGlzKTtcclxuICAgICAgICAgICAgYXdhaXQgdGhpcy5jb21taXRUcmFuc2FjdGlvbigpO1xyXG4gICAgICAgICAgICBpblhhY3QgPSBmYWxzZTtcclxuICAgICAgICAgICAgaWYgKHBvc3RDb21taXQpIHtcclxuICAgICAgICAgICAgICAgIHBvc3RDb21taXQocmVzdWx0cyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgY2F0Y2ggKGV4KSB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoaW5YYWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5yb2xsYmFja1RyYW5zYWN0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2F0Y2ggKGV4Mikge31cclxuICAgICAgICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICBlcnJvcihleCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgZmluYWxseSB7XHJcbiAgICAgICAgICAgIHRoaXMuY2xvc2UoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmNsYXNzIEJpbmRhYmxlUHJvbWlzZTxUPiB7XHJcbiAgICBwcml2YXRlIF9wcm9taXNlOiBQcm9taXNlPFQ+O1xyXG4gICAgcHJpdmF0ZSBfcmVzb2x2ZTogKHZhbHVlPzogVCB8IFByb21pc2VMaWtlPFQ+KSA9PiB2b2lkO1xyXG4gICAgcHJpdmF0ZSBfcmVqZWN0OiAocmVhc29uPzogYW55KSA9PiB2b2lkO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIHRoaXMucmVzZXQoKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgcHJvbWlzZSgpOiBQcm9taXNlPFQ+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fcHJvbWlzZTtcclxuICAgIH1cclxuXHJcbiAgICByZXNvbHZlKHZhbHVlPzogVCB8IFByb21pc2VMaWtlPFQ+KSB7XHJcbiAgICAgICAgdGhpcy5fcmVzb2x2ZSh2YWx1ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVqZWN0KHJlYXNvbj86IGFueSkge1xyXG4gICAgICAgIHRoaXMuX3JlamVjdChyZWFzb24pO1xyXG4gICAgfVxyXG5cclxuICAgIHJlc2V0KCkge1xyXG4gICAgICAgIHRoaXMuX3Byb21pc2UgPSBuZXcgUHJvbWlzZTxUPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuX3Jlc29sdmUgPSByZXNvbHZlO1xyXG4gICAgICAgICAgICB0aGlzLl9yZWplY3QgPSByZWplY3Q7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBUZHNTdGF0ZW1lbnQge1xyXG4gICAgcHJpdmF0ZSBfY29ubmVjdGlvbjogVGRzQ29ubmVjdGlvbjtcclxuICAgIHByaXZhdGUgX3JlcXVlc3Q6IHRlZGlvdXMuUmVxdWVzdDtcclxuICAgIHByaXZhdGUgX3Byb21pc2U6IEJpbmRhYmxlUHJvbWlzZTxhbnlbXT47XHJcbiAgICBwcml2YXRlIF9jb2x1bW5zOiB7IFtuYW1lOiBzdHJpbmddOiBUZHNDb2x1bW47IH0gPSB7fTtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihjb25uZWN0aW9uOiBUZHNDb25uZWN0aW9uLCBzcWxTdGF0ZW1lbnQ6IHN0cmluZykge1xyXG4gICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24gPSBjb25uZWN0aW9uO1xyXG4gICAgICAgIHRoaXMuX3Byb21pc2UgPSBuZXcgQmluZGFibGVQcm9taXNlPGFueVtdPigpO1xyXG4gICAgICAgIHRoaXMuX3JlcXVlc3QgPSBuZXcgdGVkaW91cy5SZXF1ZXN0KHNxbFN0YXRlbWVudCwgKGVycjogRXJyb3IsIHJvd0NvdW50OiBudW1iZXIsIHJvd3M6IGFueVtdKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3Byb21pc2UucmVqZWN0KGVycik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9wcm9taXNlLnJlc29sdmUocm93cy5tYXAocm93ID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fdHJhbnNmb3JtUm93KHJvdyk7XHJcbiAgICAgICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwYXJhbWV0ZXIobmFtZTogc3RyaW5nLCB0eXBlOiB0ZWRpb3VzLlRlZGlvdXNUeXBlLCB2YWx1ZTogYW55LCBvcHRpb25zPzogdGVkaW91cy5QYXJhbWV0ZXJPcHRpb25zKTogVGRzU3RhdGVtZW50IHtcclxuICAgICAgICB0aGlzLl9yZXF1ZXN0LmFkZFBhcmFtZXRlcihuYW1lLCB0eXBlLCB2YWx1ZSwgb3B0aW9ucyk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgcHJlcGFyZSgpOiBQcm9taXNlPFRkc1N0YXRlbWVudD4ge1xyXG4gICAgICAgIHZhciBvcGVuQ29ubmVjdGlvbiA9IGF3YWl0IHRoaXMuX2Nvbm5lY3Rpb24uY29ubmVjdGlvbkFzeW5jKCk7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPFRkc1N0YXRlbWVudD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICBvcGVuQ29ubmVjdGlvbi5wcmVwYXJlKHRoaXMuX3JlcXVlc3QpO1xyXG4gICAgICAgICAgICB0aGlzLl9yZXF1ZXN0Lm9uKCdwcmVwYXJlZCcsICgpID0+IHtcclxuICAgICAgICAgICAgICAgIHJlc29sdmUodGhpcyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGV4ZWN1dGVJbW1lZGlhdGUoKTogUHJvbWlzZTxhbnlbXT4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmV4ZWN1dGUodHJ1ZSwgZmFsc2UsIG51bGwpO1xyXG4gICAgfVxyXG5cclxuICAgIGV4ZWN1dGUocmVsZWFzZUNvbm5lY3Rpb246IGJvb2xlYW4sIGNhbGxTcHJvYzogYm9vbGVhbiA9IGZhbHNlLCBwYXJhbWV0ZXJzPzoge30pOiBQcm9taXNlPGFueVtdPiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPGFueVtdPihhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9wcm9taXNlLnJlc2V0KCk7XHJcbiAgICAgICAgICAgICAgICB2YXIgb3BlbkNvbm5lY3Rpb24gPSBhd2FpdCB0aGlzLl9jb25uZWN0aW9uLmNvbm5lY3Rpb25Bc3luYygpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGNhbGxTcHJvYykge1xyXG4gICAgICAgICAgICAgICAgICAgIG9wZW5Db25uZWN0aW9uLmNhbGxQcm9jZWR1cmUodGhpcy5fcmVxdWVzdCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIGlmIChwYXJhbWV0ZXJzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgb3BlbkNvbm5lY3Rpb24uZXhlY3V0ZSh0aGlzLl9yZXF1ZXN0LCBwYXJhbWV0ZXJzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIG9wZW5Db25uZWN0aW9uLmV4ZWNTcWwodGhpcy5fcmVxdWVzdCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX3Byb21pc2UucHJvbWlzZTtcclxuICAgICAgICAgICAgICAgIHJlc29sdmUocmVzdWx0cyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2F0Y2ggKGV4KSB7XHJcbiAgICAgICAgICAgICAgICByZWplY3QoZXgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgICAgICAudGhlbigodmFsdWUpID0+IHtcclxuICAgICAgICAgICAgaWYgKHJlbGVhc2VDb25uZWN0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9jb25uZWN0aW9uLmNsb3NlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHZhbHVlXHJcbiAgICAgICAgfSlcclxuICAgICAgICAuY2F0Y2goKHJlYXNvbikgPT4ge1xyXG4gICAgICAgICAgICBpZiAocmVsZWFzZUNvbm5lY3Rpb24pIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24uY2xvc2UoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QocmVhc29uKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgX3RyYW5zZm9ybVJvdyhyb3c6IGFueSkge1xyXG4gICAgICAgIHZhciByZXN1bHQgPSB7fTtcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJvdy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICB2YXIgY29sID0gcm93W2ldO1xyXG4gICAgICAgICAgICB2YXIgbWFwID0gdGhpcy5fZ2V0Q29sdW1uTWFwKGNvbC5tZXRhZGF0YS5jb2xOYW1lKTtcclxuICAgICAgICAgICAgbWFwLmFwcGx5TWFwcGluZyhjb2wsIHJlc3VsdCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIF9nZXRDb2x1bW5NYXAoY29sTmFtZTogc3RyaW5nKTogVGRzQ29sdW1uIHtcclxuICAgICAgICB2YXIgbWFwID0gdGhpcy5fY29sdW1uc1tjb2xOYW1lXTtcclxuICAgICAgICBpZiAoIW1hcCkge1xyXG4gICAgICAgICAgICBtYXAgPSBuZXcgVGRzQ29sdW1uKGNvbE5hbWUpO1xyXG4gICAgICAgICAgICB0aGlzLl9jb2x1bW5zW2NvbE5hbWVdID0gbWFwO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbWFwO1xyXG4gICAgfVxyXG59XHJcblxyXG5jbGFzcyBUZHNDb2x1bW4ge1xyXG4gICAgcHJvdGVjdGVkIF9nZXRDb2x1bW5WYWx1ZTogKGNvbHVtbjogdGVkaW91cy5Db2x1bW5WYWx1ZSkgPT4gYW55O1xyXG4gICAgcHJvdGVjdGVkIF9hcHBseU1hcHBpbmc6IChjb2x1bW46IHRlZGlvdXMuQ29sdW1uVmFsdWUsIHJlc3VsdDogYW55KSA9PiB2b2lkO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyBuYW1lOiBzdHJpbmcpIHtcclxuICAgICAgICB0aGlzLl9nZXRDb2x1bW5WYWx1ZSA9IChjb2x1bW46IHRlZGlvdXMuQ29sdW1uVmFsdWUpID0+IHsgcmV0dXJuIGNvbHVtbi52YWx1ZTsgfVxyXG4gICAgICAgIHRoaXMuX2FwcGx5TWFwcGluZyA9IChjb2x1bW46IHRlZGlvdXMuQ29sdW1uVmFsdWUsIHJlc3VsdDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHRoaXMuX2dldENvbHVtblZhbHVlKGNvbHVtbik7XHJcbiAgICAgICAgICAgIHJlc3VsdFt0aGlzLm5hbWVdID0gdmFsdWU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGFwcGx5TWFwcGluZyhjb2x1bW46IHRlZGlvdXMuQ29sdW1uVmFsdWUsIHJlc3VsdDogYW55KTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5fYXBwbHlNYXBwaW5nKGNvbHVtbiwgcmVzdWx0KTtcclxuICAgIH1cclxuXHJcbiAgICBvdmVycmlkZUdldFZhbHVlKGdldEZ1bmN0aW9uOiAoY29sdW1uOiB0ZWRpb3VzLkNvbHVtblZhbHVlKSA9PiBhbnkpOiBUZHNDb2x1bW4ge1xyXG4gICAgICAgIHRoaXMuX2dldENvbHVtblZhbHVlID0gZ2V0RnVuY3Rpb247XHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9O1xyXG5cclxuICAgIG92ZXJyaWRlQXBwbHlNYXBwaW5nKGFwcGx5RnVuY3Rpb24pOiBUZHNDb2x1bW4ge1xyXG4gICAgICAgIHRoaXMuX2FwcGx5TWFwcGluZyA9IGFwcGx5RnVuY3Rpb247XHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9O1xyXG5cclxuICAgIGFzQm9vbGVhbigpOiBUZHNDb2x1bW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm92ZXJyaWRlR2V0VmFsdWUoKGNvbHVtbjogdGVkaW91cy5Db2x1bW5WYWx1ZSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoY29sdW1uLnZhbHVlID09PSB1bmRlZmluZWQgfHwgY29sdW1uLnZhbHVlID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoXy5pc0Zpbml0ZShjb2x1bW4udmFsdWUpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gY29sdW1uLnZhbHVlICE9PSAwO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChfLmlzU3RyaW5nKGNvbHVtbi52YWx1ZSkpIHtcclxuICAgICAgICAgICAgICAgIHZhciBzdHIgPSBjb2x1bW4udmFsdWUudG9VcHBlckNhc2UoKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoc3RyID09PSAnVFJVRScgfHwgc3RyID09PSAnVCcgfHwgc3RyID09PSAnWScgfHwgc3RyID09PSAnWUVTJyB8fCBzdHIgPT09ICcxJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHN0ciA9PT0gJ0ZBTFNFJyB8fCBzdHIgPT09ICdGJyB8fCBzdHIgPT09ICdOJyB8fCBzdHIgPT09ICdOTycgfHwgc3RyID09PSAnMCcpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5hYmxlIHRvIGNvbnZlcnQgXCInICsgY29sdW1uLnZhbHVlICsgJ1wiIHRvIGEgYm9vbGVhbi4nKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgYXNEYXRlKCk6IFRkc0NvbHVtbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMub3ZlcnJpZGVHZXRWYWx1ZSgoY29sdW1uOiB0ZWRpb3VzLkNvbHVtblZhbHVlKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChjb2x1bW4udmFsdWUgPT09IHVuZGVmaW5lZCB8fCBjb2x1bW4udmFsdWUgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChfLmlzRmluaXRlKGNvbHVtbi52YWx1ZSkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRGF0ZShjb2x1bW4udmFsdWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBEYXRlLnBhcnNlKGNvbHVtbi52YWx1ZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG59Il19
