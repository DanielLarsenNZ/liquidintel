"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tedious_1 = require("tedious");
var Operators;
(function (Operators) {
    Operators[Operators["Unknown"] = 0] = "Unknown";
    Operators[Operators["EqualTo"] = 1] = "EqualTo";
    Operators[Operators["LessThan"] = 2] = "LessThan";
    Operators[Operators["GreaterThan"] = 3] = "GreaterThan";
    Operators[Operators["Range"] = 4] = "Range";
    Operators[Operators["Contains"] = 5] = "Contains";
    Operators[Operators["OrderAsc"] = 6] = "OrderAsc";
    Operators[Operators["OrderDesc"] = 7] = "OrderDesc";
})(Operators = exports.Operators || (exports.Operators = {}));
var OperatorClass;
(function (OperatorClass) {
    OperatorClass[OperatorClass["Filter"] = 0] = "Filter";
    OperatorClass[OperatorClass["Order"] = 1] = "Order";
})(OperatorClass || (OperatorClass = {}));
class QueryExpression {
    constructor(queryParams) {
        this.params = {};
        this.mapping = null;
        this.ordering = null;
        for (var prop in queryParams) {
            var paramInfo = QueryExpression.getParamInfo(prop);
            var clause = this.getClause(paramInfo[0]);
            if (clause != null) {
                if (clause.operator != paramInfo[1]) {
                    if (clause.operator == Operators.LessThan) {
                        clause.valueUpper = clause.value;
                        clause.value = queryParams[prop];
                    }
                    else {
                        clause.valueUpper = queryParams[prop];
                    }
                    clause.operator = Operators.Range;
                }
            }
            else {
                this.params[paramInfo[0].toLowerCase()] = {
                    operator: paramInfo[1],
                    value: queryParams[prop]
                };
            }
        }
    }
    getClause(paramName) {
        return this.params[paramName.toLowerCase()];
    }
    isAnyFilter() {
        if (this.mapping) {
            for (var prop in this.mapping) {
                var clause = this.getClause(prop);
                if (clause != null && QueryExpression.operatorClasses.get(clause.operator) == OperatorClass.Filter) {
                    return true;
                }
            }
            return false;
        }
        return Object.keys(this.params).length > 0;
    }
    isAnyOrdering() {
        if (this.ordering) {
            for (var prop of this.ordering) {
                var clause = this.getClause(prop);
                if (clause != null && QueryExpression.operatorClasses.get(clause.operator) == OperatorClass.Order) {
                    return true;
                }
            }
            return false;
        }
        return false;
    }
    isAnyLimit() {
        if (this.limit) {
            return this.getClause(this.limit) != null;
        }
        return false;
    }
    getSqlFilterPredicates() {
        var predicates = Object.keys(this.mapping).map(prop => {
            var clause = this.getClause(prop);
            if (clause != null && QueryExpression.operatorClasses.get(clause.operator) == OperatorClass.Filter) {
                var comparitor = "";
                switch (clause.operator) {
                    case Operators.EqualTo:
                        comparitor = "=";
                        break;
                    case Operators.GreaterThan:
                        comparitor = ">";
                        break;
                    case Operators.LessThan:
                        comparitor = "<";
                        break;
                    case Operators.Contains:
                        return `${this.mapping[prop].sqlName} IN (SELECT value FROM string_split(@${prop}, ','))`;
                    case Operators.Range:
                        return `${this.mapping[prop].sqlName} > @${prop}Low AND ` +
                            `${this.mapping[prop].sqlName} < @${prop}Hi`;
                }
                if (comparitor != "") {
                    return `${this.mapping[prop].sqlName} ${comparitor} @${prop}`;
                }
            }
            return "";
        });
        return predicates
            .filter(clause => clause != "")
            .join(" AND ");
    }
    getSqlOrderByClauses() {
        if (this.isAnyOrdering()) {
            var orderByClauses = this.ordering
                .map(prop => {
                var clause = this.getClause(prop);
                if (clause != null && QueryExpression.operatorClasses.get(clause.operator) == OperatorClass.Order) {
                    var mappedProp = this.mapping[prop];
                    if (mappedProp) {
                        prop = mappedProp.sqlName;
                    }
                    return prop + " " + (clause.operator == Operators.OrderDesc ? "DESC" : "ASC");
                }
                return "";
            });
            return "ORDER BY " + orderByClauses
                .filter(clause => clause != "")
                .join(", ");
        }
        return "";
    }
    getSqlLimitClause() {
        if (this.isAnyLimit()) {
            return " TOP " + this.getClause(this.limit).value + " ";
        }
        return "";
    }
    addRequestParameters(stmt) {
        for (var prop in this.mapping) {
            var clause = this.getClause(prop);
            if (clause != null) {
                if (clause.operator == Operators.Range) {
                    stmt.parameter(prop + "Low", this.mapping[prop].dataType, clause.value);
                    stmt.parameter(prop + "Hi", this.mapping[prop].dataType, clause.valueUpper);
                }
                else {
                    stmt.parameter(prop, clause.operator == Operators.Contains ? tedious_1.TYPES.NVarChar : this.mapping[prop].dataType, clause.value);
                }
            }
        }
    }
    static getParamInfo(paramName) {
        for (var suffix of QueryExpression.suffixOperators) {
            if (suffix[0]) {
                var retval = QueryExpression.checkParamInfo(paramName, suffix[0], suffix[1]);
                if (retval[1] != Operators.Unknown) {
                    return retval;
                }
            }
        }
        return [paramName, Operators.EqualTo];
    }
    static checkParamInfo(paramName, suffixCheck, operator) {
        var checkName = paramName.toLowerCase();
        var suffixIndex = checkName.lastIndexOf(suffixCheck);
        if (suffixIndex == checkName.length - suffixCheck.length) {
            return [paramName.substr(0, suffixIndex), operator];
        }
        return [paramName, Operators.Unknown];
    }
}
QueryExpression._suffix_gt = "_gt";
QueryExpression._suffix_lt = "_lt";
QueryExpression._suffix_in = "_in";
QueryExpression._suffix_asc = "_asc";
QueryExpression._suffix_desc = "_desc";
QueryExpression.suffixOperators = [
    [QueryExpression._suffix_gt, Operators.GreaterThan, OperatorClass.Filter],
    [QueryExpression._suffix_lt, Operators.LessThan, OperatorClass.Filter],
    [QueryExpression._suffix_in, Operators.Contains, OperatorClass.Filter],
    ["", Operators.EqualTo, OperatorClass.Filter],
    ["", Operators.Range, OperatorClass.Filter],
    [QueryExpression._suffix_asc, Operators.OrderAsc, OperatorClass.Order],
    [QueryExpression._suffix_desc, Operators.OrderDesc, OperatorClass.Order]
];
QueryExpression.operatorClasses = new Map(QueryExpression.suffixOperators.map((value) => {
    return [value[1], value[2]];
}));
exports.QueryExpression = QueryExpression;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC91dGlscy9xdWVyeV9leHByZXNzaW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBRUEscUNBQTJDO0FBRTNDLElBQVksU0FTWDtBQVRELFdBQVksU0FBUztJQUNqQiwrQ0FBTyxDQUFBO0lBQ1AsK0NBQU8sQ0FBQTtJQUNQLGlEQUFRLENBQUE7SUFDUix1REFBVyxDQUFBO0lBQ1gsMkNBQUssQ0FBQTtJQUNMLGlEQUFRLENBQUE7SUFDUixpREFBUSxDQUFBO0lBQ1IsbURBQVMsQ0FBQTtBQUNiLENBQUMsRUFUVyxTQUFTLEdBQVQsaUJBQVMsS0FBVCxpQkFBUyxRQVNwQjtBQWFELElBQUssYUFHSjtBQUhELFdBQUssYUFBYTtJQUNkLHFEQUFNLENBQUE7SUFDTixtREFBSyxDQUFBO0FBQ1QsQ0FBQyxFQUhJLGFBQWEsS0FBYixhQUFhLFFBR2pCO0FBRUQ7SUEwQkksWUFBWSxXQUFnQjtRQUxwQixXQUFNLEdBQTRCLEVBQUUsQ0FBQztRQUM3QyxZQUFPLEdBQWdDLElBQUksQ0FBQztRQUM1QyxhQUFRLEdBQWEsSUFBSSxDQUFDO1FBS3RCLEdBQUcsQ0FBQyxDQUFDLElBQUksSUFBSSxJQUFJLFdBQVcsQ0FBQyxDQUFDLENBQUM7WUFDM0IsSUFBSSxTQUFTLEdBQUcsZUFBZSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNuRCxJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzFDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUVqQixFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsUUFBUSxJQUFJLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ2xDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxRQUFRLElBQUksU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7d0JBQ3hDLE1BQU0sQ0FB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XG5pbXBvcnQgdGRzID0gcmVxdWlyZSgnLi90ZHMtcHJvbWlzZXMnKTtcclxuaW1wb3J0IHtUZWRpb3VzVHlwZSwgVFlQRVN9IGZyb20gJ3RlZGlvdXMnO1xyXG5cclxuZXhwb3J0IGVudW0gT3BlcmF0b3JzIHtcclxuICAgIFVua25vd24sXHJcbiAgICBFcXVhbFRvLFxyXG4gICAgTGVzc1RoYW4sXHJcbiAgICBHcmVhdGVyVGhhbixcclxuICAgIFJhbmdlLFxyXG4gICAgQ29udGFpbnMsXHJcbiAgICBPcmRlckFzYyxcclxuICAgIE9yZGVyRGVzYyxcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBDbGF1c2Uge1xyXG4gICAgb3BlcmF0b3I6IE9wZXJhdG9ycyxcclxuICAgIHZhbHVlOiBhbnksXHJcbiAgICB2YWx1ZVVwcGVyPzogYW55ICAgICAgICAgICAgIC8vIEZvciBSYW5nZSBjbGF1c2VzIG9ubHlcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBQcm9wTWFwcGluZyB7XHJcbiAgICBzcWxOYW1lOiBzdHJpbmcsXHJcbiAgICBkYXRhVHlwZTogVGVkaW91c1R5cGVcclxufVxyXG5cclxuZW51bSBPcGVyYXRvckNsYXNzIHtcclxuICAgIEZpbHRlcixcclxuICAgIE9yZGVyLFxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgUXVlcnlFeHByZXNzaW9uIHtcclxuICAgIHByaXZhdGUgc3RhdGljIF9zdWZmaXhfZ3Q6IHN0cmluZyAgID0gXCJfZ3RcIjtcclxuICAgIHByaXZhdGUgc3RhdGljIF9zdWZmaXhfbHQ6IHN0cmluZyAgID0gXCJfbHRcIjtcclxuICAgIHByaXZhdGUgc3RhdGljIF9zdWZmaXhfaW46IHN0cmluZyAgID0gXCJfaW5cIjtcclxuICAgIHByaXZhdGUgc3RhdGljIF9zdWZmaXhfYXNjOiBzdHJpbmcgID0gXCJfYXNjXCI7XHJcbiAgICBwcml2YXRlIHN0YXRpYyBfc3VmZml4X2Rlc2M6IHN0cmluZyA9IFwiX2Rlc2NcIjtcclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBzdWZmaXhPcGVyYXRvcnM6IFtzdHJpbmcsIE9wZXJhdG9ycywgT3BlcmF0b3JDbGFzc11bXSA9IFtcclxuICAgICAgICBbUXVlcnlFeHByZXNzaW9uLl9zdWZmaXhfZ3QsIE9wZXJhdG9ycy5HcmVhdGVyVGhhbiwgT3BlcmF0b3JDbGFzcy5GaWx0ZXJdLFxyXG4gICAgICAgIFtRdWVyeUV4cHJlc3Npb24uX3N1ZmZpeF9sdCwgT3BlcmF0b3JzLkxlc3NUaGFuLCBPcGVyYXRvckNsYXNzLkZpbHRlcl0sXHJcbiAgICAgICAgW1F1ZXJ5RXhwcmVzc2lvbi5fc3VmZml4X2luLCBPcGVyYXRvcnMuQ29udGFpbnMsIE9wZXJhdG9yQ2xhc3MuRmlsdGVyXSxcclxuICAgICAgICBbXCJcIiwgT3BlcmF0b3JzLkVxdWFsVG8sIE9wZXJhdG9yQ2xhc3MuRmlsdGVyXSxcclxuICAgICAgICBbXCJcIiwgT3BlcmF0b3JzLlJhbmdlLCBPcGVyYXRvckNsYXNzLkZpbHRlcl0sXHJcbiAgICAgICAgW1F1ZXJ5RXhwcmVzc2lvbi5fc3VmZml4X2FzYywgT3BlcmF0b3JzLk9yZGVyQXNjLCBPcGVyYXRvckNsYXNzLk9yZGVyXSxcclxuICAgICAgICBbUXVlcnlFeHByZXNzaW9uLl9zdWZmaXhfZGVzYywgT3BlcmF0b3JzLk9yZGVyRGVzYywgT3BlcmF0b3JDbGFzcy5PcmRlcl1cclxuICAgIF07XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgb3BlcmF0b3JDbGFzc2VzID0gbmV3IE1hcChRdWVyeUV4cHJlc3Npb24uc3VmZml4T3BlcmF0b3JzLm1hcCgodmFsdWU6IFtzdHJpbmcsIE9wZXJhdG9ycywgT3BlcmF0b3JDbGFzc10pID0+IHtcclxuICAgICAgICByZXR1cm4gPFtPcGVyYXRvcnMsIE9wZXJhdG9yQ2xhc3NdPlt2YWx1ZVsxXSwgdmFsdWVbMl1dO1xyXG4gICAgfSkpO1xyXG5cclxuICAgIHByaXZhdGUgcGFyYW1zOiB7W2tleTpzdHJpbmddOiBDbGF1c2U7fSA9IHt9O1xyXG4gICAgbWFwcGluZzoge1trZXk6c3RyaW5nXTogUHJvcE1hcHBpbmd9ID0gbnVsbDtcclxuICAgIG9yZGVyaW5nOiBzdHJpbmdbXSA9IG51bGw7XHJcbiAgICBsaW1pdDogc3RyaW5nO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHF1ZXJ5UGFyYW1zOiBhbnkpIHtcclxuXHJcbiAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBxdWVyeVBhcmFtcykge1xyXG4gICAgICAgICAgICB2YXIgcGFyYW1JbmZvID0gUXVlcnlFeHByZXNzaW9uLmdldFBhcmFtSW5mbyhwcm9wKTtcclxuICAgICAgICAgICAgdmFyIGNsYXVzZSA9IHRoaXMuZ2V0Q2xhdXNlKHBhcmFtSW5mb1swXSk7XHJcbiAgICAgICAgICAgIGlmIChjbGF1c2UgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgLy8gVmVyaWZ5IHRoYXQgdGhpcyBpcyBub3cgYSByYW5nZSBjbGF1c2VcclxuICAgICAgICAgICAgICAgIGlmIChjbGF1c2Uub3BlcmF0b3IgIT0gcGFyYW1JbmZvWzFdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNsYXVzZS5vcGVyYXRvciA9PSBPcGVyYXRvcnMuTGVzc1RoYW4pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2xhdXNlLnZhbHVlVXBwZXIgPSBjbGF1c2UudmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXVzZS52YWx1ZSA9IHF1ZXJ5UGFyYW1zW3Byb3BdO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2xhdXNlLnZhbHVlVXBwZXIgPSBxdWVyeVBhcmFtc1twcm9wXTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgY2xhdXNlLm9wZXJhdG9yID0gT3BlcmF0b3JzLlJhbmdlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wYXJhbXNbcGFyYW1JbmZvWzBdLnRvTG93ZXJDYXNlKCldID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIG9wZXJhdG9yOiBwYXJhbUluZm9bMV0sXHJcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHF1ZXJ5UGFyYW1zW3Byb3BdXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGdldENsYXVzZShwYXJhbU5hbWU6c3RyaW5nKTogQ2xhdXNlIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5wYXJhbXNbcGFyYW1OYW1lLnRvTG93ZXJDYXNlKCldO1xyXG4gICAgfVxyXG5cclxuICAgIGlzQW55RmlsdGVyKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIGlmICh0aGlzLm1hcHBpbmcpIHtcclxuICAgICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiB0aGlzLm1hcHBpbmcpIHtcclxuICAgICAgICAgICAgICAgIHZhciBjbGF1c2UgPSB0aGlzLmdldENsYXVzZShwcm9wKTtcclxuICAgICAgICAgICAgICAgIGlmIChjbGF1c2UgIT0gbnVsbCAmJiBRdWVyeUV4cHJlc3Npb24ub3BlcmF0b3JDbGFzc2VzLmdldChjbGF1c2Uub3BlcmF0b3IpID09IE9wZXJhdG9yQ2xhc3MuRmlsdGVyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGlzLnBhcmFtcykubGVuZ3RoID4gMDtcclxuICAgIH1cclxuXHJcbiAgICBpc0FueU9yZGVyaW5nKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIGlmICh0aGlzLm9yZGVyaW5nKSB7XHJcbiAgICAgICAgICAgIGZvciAodmFyIHByb3Agb2YgdGhpcy5vcmRlcmluZykge1xyXG4gICAgICAgICAgICAgICAgdmFyIGNsYXVzZSA9IHRoaXMuZ2V0Q2xhdXNlKHByb3ApO1xyXG4gICAgICAgICAgICAgICAgaWYgKGNsYXVzZSAhPSBudWxsICYmIFF1ZXJ5RXhwcmVzc2lvbi5vcGVyYXRvckNsYXNzZXMuZ2V0KGNsYXVzZS5vcGVyYXRvcikgPT0gT3BlcmF0b3JDbGFzcy5PcmRlcikge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgaXNBbnlMaW1pdCgpOiBib29sZWFuIHtcclxuICAgICAgICBpZiAodGhpcy5saW1pdCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRDbGF1c2UodGhpcy5saW1pdCkgIT0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFNxbEZpbHRlclByZWRpY2F0ZXMoKTogc3RyaW5nIHtcclxuICAgICAgICB2YXIgcHJlZGljYXRlcyA9IE9iamVjdC5rZXlzKHRoaXMubWFwcGluZykubWFwKHByb3AgPT4ge1xyXG4gICAgICAgICAgICB2YXIgY2xhdXNlID0gdGhpcy5nZXRDbGF1c2UocHJvcCk7XHJcbiAgICAgICAgICAgIGlmIChjbGF1c2UgIT0gbnVsbCAmJiBRdWVyeUV4cHJlc3Npb24ub3BlcmF0b3JDbGFzc2VzLmdldChjbGF1c2Uub3BlcmF0b3IpID09IE9wZXJhdG9yQ2xhc3MuRmlsdGVyKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgY29tcGFyaXRvciA9IFwiXCI7XHJcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKGNsYXVzZS5vcGVyYXRvcikge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgT3BlcmF0b3JzLkVxdWFsVG86XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBhcml0b3IgPSBcIj1cIjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgT3BlcmF0b3JzLkdyZWF0ZXJUaGFuOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb21wYXJpdG9yID0gXCI+XCI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBjYXNlIE9wZXJhdG9ycy5MZXNzVGhhbjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29tcGFyaXRvciA9IFwiPFwiO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBPcGVyYXRvcnMuQ29udGFpbnM6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBgJHt0aGlzLm1hcHBpbmdbcHJvcF0uc3FsTmFtZX0gSU4gKFNFTEVDVCB2YWx1ZSBGUk9NIHN0cmluZ19zcGxpdChAJHtwcm9wfSwgJywnKSlgO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBjYXNlIE9wZXJhdG9ycy5SYW5nZTpcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGAke3RoaXMubWFwcGluZ1twcm9wXS5zcWxOYW1lfSA+IEAke3Byb3B9TG93IEFORCBgICsgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJHt0aGlzLm1hcHBpbmdbcHJvcF0uc3FsTmFtZX0gPCBAJHtwcm9wfUhpYDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChjb21wYXJpdG9yICE9IFwiXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYCR7dGhpcy5tYXBwaW5nW3Byb3BdLnNxbE5hbWV9ICR7Y29tcGFyaXRvcn0gQCR7cHJvcH1gO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBcIlwiO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBwcmVkaWNhdGVzXHJcbiAgICAgICAgICAgIC5maWx0ZXIoY2xhdXNlID0+IGNsYXVzZSAhPSBcIlwiKSBcclxuICAgICAgICAgICAgLmpvaW4oXCIgQU5EIFwiKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRTcWxPcmRlckJ5Q2xhdXNlcygpOiBzdHJpbmcge1xyXG4gICAgICAgIGlmICh0aGlzLmlzQW55T3JkZXJpbmcoKSkge1xyXG4gICAgICAgICAgICB2YXIgb3JkZXJCeUNsYXVzZXMgPSB0aGlzLm9yZGVyaW5nXHJcbiAgICAgICAgICAgICAgICAubWFwKHByb3AgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBjbGF1c2UgPSB0aGlzLmdldENsYXVzZShwcm9wKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoY2xhdXNlICE9IG51bGwgJiYgUXVlcnlFeHByZXNzaW9uLm9wZXJhdG9yQ2xhc3Nlcy5nZXQoY2xhdXNlLm9wZXJhdG9yKSA9PSBPcGVyYXRvckNsYXNzLk9yZGVyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtYXBwZWRQcm9wID0gdGhpcy5tYXBwaW5nW3Byb3BdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobWFwcGVkUHJvcCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcCA9IG1hcHBlZFByb3Auc3FsTmFtZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHJvcCArIFwiIFwiICsgKGNsYXVzZS5vcGVyYXRvciA9PSBPcGVyYXRvcnMuT3JkZXJEZXNjID8gXCJERVNDXCIgOiBcIkFTQ1wiKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFwiXCI7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICByZXR1cm4gXCJPUkRFUiBCWSBcIiArIG9yZGVyQnlDbGF1c2VzXHJcbiAgICAgICAgICAgICAgICAuZmlsdGVyKGNsYXVzZSA9PiBjbGF1c2UgIT0gXCJcIilcclxuICAgICAgICAgICAgICAgIC5qb2luKFwiLCBcIik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBcIlwiO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFNxbExpbWl0Q2xhdXNlKCk6IHN0cmluZyB7XHJcbiAgICAgICAgaWYgKHRoaXMuaXNBbnlMaW1pdCgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBcIiBUT1AgXCIgKyB0aGlzLmdldENsYXVzZSh0aGlzLmxpbWl0KS52YWx1ZSArIFwiIFwiO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gXCJcIjtcclxuICAgIH1cclxuXHJcbiAgICBhZGRSZXF1ZXN0UGFyYW1ldGVycyhzdG10OiB0ZHMuVGRzU3RhdGVtZW50KSB7XHJcbiAgICAgICAgZm9yICh2YXIgcHJvcCBpbiB0aGlzLm1hcHBpbmcpIHtcclxuICAgICAgICAgICAgdmFyIGNsYXVzZSA9IHRoaXMuZ2V0Q2xhdXNlKHByb3ApO1xyXG4gICAgICAgICAgICBpZiAoY2xhdXNlICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIGlmIChjbGF1c2Uub3BlcmF0b3IgPT0gT3BlcmF0b3JzLlJhbmdlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc3RtdC5wYXJhbWV0ZXIocHJvcCArIFwiTG93XCIsIHRoaXMubWFwcGluZ1twcm9wXS5kYXRhVHlwZSwgY2xhdXNlLnZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICBzdG10LnBhcmFtZXRlcihwcm9wICsgXCJIaVwiLCB0aGlzLm1hcHBpbmdbcHJvcF0uZGF0YVR5cGUsIGNsYXVzZS52YWx1ZVVwcGVyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHN0bXQucGFyYW1ldGVyKHByb3AsIGNsYXVzZS5vcGVyYXRvciA9PSBPcGVyYXRvcnMuQ29udGFpbnMgPyBUWVBFUy5OVmFyQ2hhciA6IHRoaXMubWFwcGluZ1twcm9wXS5kYXRhVHlwZSwgY2xhdXNlLnZhbHVlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyBnZXRQYXJhbUluZm8ocGFyYW1OYW1lOiBzdHJpbmcpOiBbc3RyaW5nLCBPcGVyYXRvcnNdIHtcclxuICAgICAgICBmb3IgKHZhciBzdWZmaXggb2YgUXVlcnlFeHByZXNzaW9uLnN1ZmZpeE9wZXJhdG9ycykge1xyXG4gICAgICAgICAgICBpZiAoc3VmZml4WzBdKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgcmV0dmFsID0gUXVlcnlFeHByZXNzaW9uLmNoZWNrUGFyYW1JbmZvKHBhcmFtTmFtZSwgc3VmZml4WzBdLCBzdWZmaXhbMV0pO1xyXG4gICAgICAgICAgICAgICAgaWYgKHJldHZhbFsxXSAhPSBPcGVyYXRvcnMuVW5rbm93bikge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXR2YWw7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIFtwYXJhbU5hbWUsIE9wZXJhdG9ycy5FcXVhbFRvXTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyBjaGVja1BhcmFtSW5mbyhwYXJhbU5hbWU6IHN0cmluZywgc3VmZml4Q2hlY2s6IHN0cmluZywgb3BlcmF0b3I6IE9wZXJhdG9ycyk6IFtzdHJpbmcsIE9wZXJhdG9yc10ge1xyXG4gICAgICAgIHZhciBjaGVja05hbWUgPSBwYXJhbU5hbWUudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICB2YXIgc3VmZml4SW5kZXggPSBjaGVja05hbWUubGFzdEluZGV4T2Yoc3VmZml4Q2hlY2spO1xyXG4gICAgICAgIGlmIChzdWZmaXhJbmRleCA9PSBjaGVja05hbWUubGVuZ3RoIC0gc3VmZml4Q2hlY2subGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBbcGFyYW1OYW1lLnN1YnN0cigwLCBzdWZmaXhJbmRleCksIG9wZXJhdG9yXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIFtwYXJhbU5hbWUsIE9wZXJhdG9ycy5Vbmtub3duXTtcclxuICAgIH1cclxuXHJcbn1cclxuXHJcbiJdfQ==
