"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const tds = require("../utils/tds-promises");
const tedious_1 = require("tedious");
const untappd = require("../utils/untappd");
function getCurrentKeg_Internal(tapId) {
    return new Promise((resolve, reject) => __awaiter(this, void 0, void 0, function* () {
        try {
            var sqlStatement = "SELECT i.TapId, i.InstallDate, i.kegSizeInML, i.currentVolumeInML, " +
                "    k.Id as KegId, k.Name, k.Brewery, k.BeerType, k.ABV, k.IBU, " +
                "    k.BeerDescription, k.UntappdId, k.imagePath " +
                "FROM FactKegInstall i INNER JOIN DimKeg k ON i.KegId = k.Id " +
                "WHERE i.isCurrent = 1 ";
            if (tapId != null) {
                sqlStatement += "AND i.TapId = @tap_id ";
            }
            sqlStatement += "ORDER BY i.TapId";
            var stmt = tds.default.sql(sqlStatement);
            if (tapId != null) {
                stmt.parameter('tap_id', tedious_1.TYPES.Int, tapId);
            }
            let results = yield stmt.executeImmediate();
            resolve(results.map(row => {
                return {
                    'TapId': row.TapId,
                    'KegId': row.KegId,
                    'InstallDate': row.InstallDate,
                    'KegSize': row.kegSizeInML,
                    'CurrentVolume': row.currentVolumeInML,
                    'Name': row.Name,
                    'Brewery': row.Brewery,
                    'BeerType': row.BeerType,
                    'ABV': row.ABV,
                    'IBU': row.IBU,
                    'BeerDescription': row.BeerDescription,
                    'UntappdId': row.UntappdId,
                    'imagePath': row.imagePath
                };
            }));
        }
        catch (ex) {
            reject(ex);
        }
    }));
}
exports.getCurrentKeg_Internal = getCurrentKeg_Internal;
function getCurrentKeg(tapId, outputFunc) {
    return __awaiter(this, void 0, void 0, function* () {
        try {
            let results = yield getCurrentKeg_Internal(tapId);
            if (tapId != null) {
                if (results.length == 0) {
                    outputFunc({ code: 404, msg: 'Current Keg(s) Not Found!' });
                }
                else {
                    outputFunc({ code: 200, msg: results[0] });
                }
            }
            else {
                outputFunc({ code: 200, msg: results });
            }
        }
        catch (ex) {
            outputFunc({ code: 500, msg: ex });
        }
    });
}
exports.getCurrentKeg = getCurrentKeg;
function postPreviouslyInstalledKeg(kegId, tapId, kegSize, outputFunc) {
    return __awaiter(this, void 0, void 0, function* () {
        new tds.TdsConnection().transaction((connection) => __awaiter(this, void 0, void 0, function* () {
            var sqlStatement = "UPDATE FactKegInstall " +
                "SET isCurrent = 0 " +
                "WHERE TapId = @tapId";
            yield connection.sql(sqlStatement)
                .parameter("tapId", tedious_1.TYPES.Int, tapId)
                .execute(false);
            sqlStatement = "INSERT INTO FactKegInstall (TapId, KegId, InstallDate, kegSizeInML, currentVolumeInML, isCurrent) " +
                "VALUES (@tapId, @kegId, @installDate, @kegSize, @kegSize, 1)";
            yield connection.sql(sqlStatement)
                .parameter("tapId", tedious_1.TYPES.Int, tapId)
                .parameter("kegId", tedious_1.TYPES.Int, kegId)
                .parameter("installDate", tedious_1.TYPES.DateTime2, new Date(Date.now()))
                .parameter("kegSize", tedious_1.TYPES.Decimal, kegSize)
                .execute(false);
        }), () => getCurrentKeg(tapId, outputFunc), (err) => outputFunc({ code: 500, msg: "Failed to post new keg: " + err }));
    });
}
exports.postPreviouslyInstalledKeg = postPreviouslyInstalledKeg;
function getKeg(kegId, outputFunc) {
    return __awaiter(this, void 0, void 0, function* () {
        try {
            var sqlStatement = "SELECT k.Id, k.Name, k.Brewery, k.BeerType, k.ABV, k.IBU, " +
                "    k.BeerDescription, k.UntappdId, k.imagePath " +
                "FROM DimKeg k ";
            if (kegId != null) {
                sqlStatement += "WHERE Id = @keg_id";
            }
            var stmt = tds.default.sql(sqlStatement);
            if (kegId != null) {
                stmt.parameter('keg_id', tedious_1.TYPES.Int, kegId);
            }
            let results = yield stmt.executeImmediate();
            let output = results.map((row) => {
                return {
                    KegId: row.Id,
                    Name: row.Name,
                    Brewery: row.Brewery,
                    BeerType: row.BeerType,
                    ABV: row.ABV,
                    IBU: row.IBU,
                    BeerDescription: row.BeerDescription,
                    UntappdId: row.UntappdId,
                    imagePath: row.imagePath
                };
            });
            if (kegId) {
                if (output.length == 0) {
                    return outputFunc({ code: 404, msg: 'Specified keg could not be found' });
                }
                else {
                    return outputFunc({ code: 200, msg: output[0] });
                }
            }
            else {
                return outputFunc({ code: 200, msg: output });
            }
        }
        catch (ex) {
            return outputFunc({ code: 500, msg: 'Internal Error: ' + ex });
        }
    });
}
exports.getKeg = getKeg;
function postNewKeg(body, output) {
    return __awaiter(this, void 0, void 0, function* () {
        try {
            if (body.UntappdId && untappd.isIntegrationEnabled()) {
                var beerInfo = yield untappd.getBeerInfo(body.UntappdId);
                body.Name = beerInfo.beer_name;
                body.Brewery = beerInfo.brewery_name;
                body.BeerType = beerInfo.beer_style;
                body.ABV = beerInfo.beer_abv;
                body.IBU = beerInfo.beer_ibu;
                body.BeerDescription = beerInfo.beer_description;
                body.imagePath = beerInfo.beer_label_image;
            }
            var sqlStatement = "INSERT INTO DimKeg " +
                "(Name, Brewery, BeerType, ABV, IBU, BeerDescription, UntappdId, imagePath) " +
                "VALUES (@name, @brewery, @beerType, @abv, @ibu, @beerDescription, @untappdId, @imagePath); " +
                "SELECT SCOPE_IDENTITY() as Id;";
            var results = yield tds.default.sql(sqlStatement)
                .parameter("name", tedious_1.TYPES.NVarChar, body.Name)
                .parameter("brewery", tedious_1.TYPES.NVarChar, body.Brewery)
                .parameter("beerType", tedious_1.TYPES.NVarChar, body.BeerType)
                .parameter("abv", tedious_1.TYPES.Decimal, body.ABV, { scale: 1 })
                .parameter("ibu", tedious_1.TYPES.Int, body.IBU)
                .parameter("beerDescription", tedious_1.TYPES.NVarChar, body.BeerDescription)
                .parameter("untappdId", tedious_1.TYPES.Int, body.UntappdId)
                .parameter("imagePath", tedious_1.TYPES.NVarChar, body.imagePath)
                .executeImmediate();
            getKeg(results[0].Id, output);
        }
        catch (ex) {
            console.error('kegController.postNewKeg error: ' + ex);
            output({ code: 500, msg: 'Internal error: ' + ex });
        }
    });
}
exports.postNewKeg = postNewKeg;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9jb250cm9sbGVycy9rZWdDb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFFQSw2Q0FBOEM7QUFDOUMscUNBQThCO0FBQzlCLDRDQUE0QztBQUU1QyxnQ0FBdUMsS0FBYTtJQUNoRCxNQUFNLENBQUMsSUFBSSxPQUFPLENBQVEsQ0FBTyxPQUFPLEVBQUUsTUFBTTtRQUM1QyxJQUFJLENBQUM7WUFDRCxJQUFJLFlBQVksR0FBRyxxRUFBcUU7Z0JBQ3hFLGtFQUFrRTtnQkFDbEUsa0RBQWtEO2dCQUNsRCw4REFBOEQ7Z0JBQzlELHdCQUF3QixDQUFDO1lBQ3pDLEVBQUUsQ0FBQyxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUNoQixZQUFZLElBQUksd0JBQXdCLENBQUE7WUFDNUMsQ0FBQztZQUNELFlBQVksSUFBSSxrQkFBa0IsQ0FBQztZQUNuQyxJQUFJLElBQUksR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUN6QyxFQUFFLENBQUMsQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDaEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsZUFBSyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUMvQyxDQUFDO1lBQ0QsSUFBSSxPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUM1QyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHO2dCQUNuQixNQUFNLENBQUM7b0JBQ0gsT0FBTyxFQUFFLEdBQUcsQ0FBQyxLQUFLO29CQUNsQixPQUFPLEVBQUUsR0FBRyxDQUFDLEtBQUs7b0JBQ2xCLGFBQWEsRUFBRSxHQUFHLENBQUMsV0FBVztvQkFDOUIsU0FBUyxFQUFFLEdBQUcsQ0FBQyxXQUFXO29CQUMxQixlQUFlLEVBQUUsR0FBRyxDQUFDLGlCQUFpQjtvQkFDdEMs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QUFFLGVBQUssQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLGVBQWUsQ0FBQztpQkFDbEUsU0FBUyxDQUFDLFdBQVcsRUFBRSxlQUFLLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7aUJBQ2pELFNBQVMsQ0FBQyxXQUFXLEVBQUUsZUFBSyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO2lCQUN0RCxnQkFBZ0IsRUFBRSxDQUFDO1lBQ3hCLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ2xDLENBQUM7UUFDRCxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ1IsT0FBTyxDQUFDLEtBQUssQ0FBQyxrQ0FBa0MsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUN2RCxNQUFNLENBQUMsRUFBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxrQkFBa0IsR0FBRyxFQUFFLEVBQUMsQ0FBQyxDQUFDO1FBQ3RELENBQUM7SUFDTCxDQUFDO0NBQUE7QUFqQ0QsZ0NBaUNDIiwiZmlsZSI6ImFwcC9jb250cm9sbGVycy9rZWdDb250cm9sbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCBleHByZXNzID0gcmVxdWlyZSgnZXhwcmVzcycpO1xyXG5pbXBvcnQgdGRzID0gcmVxdWlyZSgnLi4vdXRpbHMvdGRzLXByb21pc2VzJyk7XHJcbmltcG9ydCB7VFlQRVN9IGZyb20gJ3RlZGlvdXMnO1xyXG5pbXBvcnQgdW50YXBwZCA9IHJlcXVpcmUoJy4uL3V0aWxzL3VudGFwcGQnKVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldEN1cnJlbnRLZWdfSW50ZXJuYWwodGFwSWQ6IG51bWJlcik6IFByb21pc2U8YW55W10+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZTxhbnlbXT4oYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHZhciBzcWxTdGF0ZW1lbnQgPSBcIlNFTEVDVCBpLlRhcElkLCBpLkluc3RhbGxEYXRlLCBpLmtlZ1NpemVJbk1MLCBpLmN1cnJlbnRWb2x1bWVJbk1MLCBcIiArIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCIgICAgay5JZCBhcyBLZWdJZCwgay5OYW1lLCBrLkJyZXdlcnksIGsuQmVlclR5cGUsIGsuQUJWLCBrLklCVSwgXCIgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCIgICAgay5CZWVyRGVzY3JpcHRpb24sIGsuVW50YXBwZElkLCBrLmltYWdlUGF0aCBcIiArXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIkZST00gRmFjdEtlZ0luc3RhbGwgaSBJTk5FUiBKT0lOIERpbUtlZyBrIE9OIGkuS2VnSWQgPSBrLklkIFwiICtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiV0hFUkUgaS5pc0N1cnJlbnQgPSAxIFwiO1xyXG4gICAgICAgICAgICBpZiAodGFwSWQgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgc3FsU3RhdGVtZW50ICs9IFwiQU5EIGkuVGFwSWQgPSBAdGFwX2lkIFwiXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgc3FsU3RhdGVtZW50ICs9IFwiT1JERVIgQlkgaS5UYXBJZFwiO1xyXG4gICAgICAgICAgICB2YXIgc3RtdCA9IHRkcy5kZWZhdWx0LnNxbChzcWxTdGF0ZW1lbnQpO1xyXG4gICAgICAgICAgICBpZiAodGFwSWQgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgc3RtdC5wYXJhbWV0ZXIoJ3RhcF9pZCcsIFRZUEVTLkludCwgdGFwSWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxldCByZXN1bHRzID0gYXdhaXQgc3RtdC5leGVjdXRlSW1tZWRpYXRlKCk7XHJcbiAgICAgICAgICAgIHJlc29sdmUocmVzdWx0cy5tYXAocm93ID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgJ1RhcElkJzogcm93LlRhcElkLFxyXG4gICAgICAgICAgICAgICAgICAgICdLZWdJZCc6IHJvdy5LZWdJZCxcclxuICAgICAgICAgICAgICAgICAgICAnSW5zdGFsbERhdGUnOiByb3cuSW5zdGFsbERhdGUsXHJcbiAgICAgICAgICAgICAgICAgICAgJ0tlZ1NpemUnOiByb3cua2VnU2l6ZUluTUwsXHJcbiAgICAgICAgICAgICAgICAgICAgJ0N1cnJlbnRWb2x1bWUnOiByb3cuY3VycmVudFZvbHVtZUluTUwsXHJcbiAgICAgICAgICAgICAgICAgICAgJ05hbWUnOiByb3cuTmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAnQnJld2VyeSc6IHJvdy5CcmV3ZXJ5LFxyXG4gICAgICAgICAgICAgICAgICAgICdCZWVyVHlwZSc6IHJvdy5CZWVyVHlwZSxcclxuICAgICAgICAgICAgICAgICAgICAnQUJWJzogcm93LkFCVixcclxuICAgICAgICAgICAgICAgICAgICAnSUJVJzogcm93LklCVSxcclxuICAgICAgICAgICAgICAgICAgICAnQmVlckRlc2NyaXB0aW9uJzogcm93LkJlZXJEZXNjcmlwdGlvbixcclxuICAgICAgICAgICAgICAgICAgICAnVW50YXBwZElkJzogcm93LlVudGFwcGRJZCxcclxuICAgICAgICAgICAgICAgICAgICAnaW1hZ2VQYXRoJzogcm93LmltYWdlUGF0aFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoZXgpIHtcclxuICAgICAgICAgICAgcmVqZWN0KGV4KTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufVxyXG5cclxuLy8gVGhpcyBpcyB0aGUgbWV0aG9kIGNhbGxhYmxlIHZpYSBleHByZXNzIHJvdXRlcyAtIHRoZSBvdXRwdXRGdW5jIHdpbGwgc2VuZCBvdXRwdXQgdG8gYW4gZXhwcmVzcy5SZXNwb25zZSBvYmplY3RcclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEN1cnJlbnRLZWcodGFwSWQ6IG51bWJlciwgb3V0cHV0RnVuYzogKHJlc3A6YW55KSA9PiBleHByZXNzLlJlc3BvbnNlKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIGxldCByZXN1bHRzID0gYXdhaXQgZ2V0Q3VycmVudEtlZ19JbnRlcm5hbCh0YXBJZCk7XHJcbiAgICAgICAgaWYgKHRhcElkICE9IG51bGwpIHtcclxuICAgICAgICAgICAgaWYgKHJlc3VsdHMubGVuZ3RoID09IDApIHtcclxuICAgICAgICAgICAgICAgIG91dHB1dEZ1bmMoe2NvZGU6IDQwNCwgbXNnOidDdXJyZW50IEtlZyhzKSBOb3QgRm91bmQhJ30pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgb3V0cHV0RnVuYyh7Y29kZTogMjAwLCBtc2c6IHJlc3VsdHNbMF19KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgb3V0cHV0RnVuYyh7IGNvZGU6IDIwMCwgbXNnOiByZXN1bHRzfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgY2F0Y2ggKGV4KSB7XHJcbiAgICAgICAgb3V0cHV0RnVuYyh7Y29kZTogNTAwLCBtc2c6IGV4fSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwb3N0UHJldmlvdXNseUluc3RhbGxlZEtlZyhrZWdJZDogbnVtYmVyLCB0YXBJZDogbnVtYmVyLCBrZWdTaXplOiBudW1iZXIsIG91dHB1dEZ1bmM6IChyZXNwOmFueSkgPT4gZXhwcmVzcy5SZXNwb25zZSkge1xyXG4gICAgbmV3IHRkcy5UZHNDb25uZWN0aW9uKCkudHJhbnNhY3Rpb24oYXN5bmMgKGNvbm5lY3Rpb246IHRkcy5UZHNDb25uZWN0aW9uKSA9PiB7XHJcbiAgICAgICAgLy8gRGVhY3RpdmF0ZSBhbnkgY3VycmVudCBrZWdzIG9uIHRoaXMgdGFwXHJcbiAgICAgICAgdmFyIHNxbFN0YXRlbWVudCA9IFwiVVBEQVRFIEZhY3RLZWdJbnN0YWxsIFwiICtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJTRVQgaXNDdXJyZW50ID0gMCBcIiArIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBcIldIRVJFIFRhcElkID0gQHRhcElkXCI7XHJcbiAgICAgICAgYXdhaXQgY29ubmVjdGlvbi5zcWwoc3FsU3RhdGVtZW50KVxyXG4gICAgICAgICAgICAucGFyYW1ldGVyKFwidGFwSWRcIiwgVFlQRVMuSW50LCB0YXBJZClcclxuICAgICAgICAgICAgLmV4ZWN1dGUoZmFsc2UpO1xyXG4gICAgICAgIC8vIEluc3RhbGwgdGhlIG5ldyBrZWcgb24gdGhlIHNwZWNpZmllZCB0YXBcclxuICAgICAgICBzcWxTdGF0ZW1lbnQgPSBcIklOU0VSVCBJTlRPIEZhY3RLZWdJbnN0YWxsIChUYXBJZCwgS2VnSWQsIEluc3RhbGxEYXRlLCBrZWdTaXplSW5NTCwgY3VycmVudFZvbHVtZUluTUwsIGlzQ3VycmVudCkgXCIgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgIFwiVkFMVUVTIChAdGFwSWQsIEBrZWdJZCwgQGluc3RhbGxEYXRlLCBAa2VnU2l6ZSwgQGtlZ1NpemUsIDEpXCI7XHJcbiAgICAgICAgYXdhaXQgY29ubmVjdGlvbi5zcWwoc3FsU3RhdGVtZW50KVxyXG4gICAgICAgICAgICAucGFyYW1ldGVyKFwidGFwSWRcIiwgVFlQRVMuSW50LCB0YXBJZClcclxuICAgICAgICAgICAgLnBhcmFtZXRlcihcImtlZ0lkXCIsIFRZUEVTLkludCwga2VnSWQpXHJcbiAgICAgICAgICAgIC5wYXJhbWV0ZXIoXCJpbnN0YWxsRGF0ZVwiLCBUWVBFUy5EYXRlVGltZTIsIG5ldyBEYXRlKERhdGUubm93KCkpKVxyXG4gICAgICAgICAgICAucGFyYW1ldGVyKFwia2VnU2l6ZVwiLCBUWVBFUy5EZWNpbWFsLCBrZWdTaXplKVxyXG4gICAgICAgICAgICAuZXhlY3V0ZShmYWxzZSk7XHJcbiAgICB9LCBcclxuICAgICgpID0+IGdldEN1cnJlbnRLZWcodGFwSWQsIG91dHB1dEZ1bmMpLFxyXG4gICAgKGVycikgPT4gb3V0cHV0RnVuYyh7Y29kZTogNTAwLCBtc2c6IFwiRmFpbGVkIHRvIHBvc3QgbmV3IGtlZzogXCIgKyBlcnJ9KSk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRLZWcoa2VnSWQ6IG51bWJlciwgb3V0cHV0RnVuYzogKHJlc3A6YW55KSA9PiBleHByZXNzLlJlc3BvbnNlKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIHZhciBzcWxTdGF0ZW1lbnQgPSBcIlNFTEVDVCBrLklkLCBrLk5hbWUsIGsuQnJld2VyeSwgay5CZWVyVHlwZSwgay5BQlYsIGsuSUJVLCBcIiArXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiICAgIGsuQmVlckRlc2NyaXB0aW9uLCBrLlVudGFwcGRJZCwgay5pbWFnZVBhdGggXCIgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBcIkZST00gRGltS2VnIGsgXCI7XHJcbiAgICAgICAgaWYgKGtlZ0lkICE9IG51bGwpIHtcclxuICAgICAgICAgICAgc3FsU3RhdGVtZW50ICs9IFwiV0hFUkUgSWQgPSBAa2VnX2lkXCI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBzdG10ID0gdGRzLmRlZmF1bHQuc3FsKHNxbFN0YXRlbWVudCk7XHJcbiAgICAgICAgaWYgKGtlZ0lkICE9IG51bGwpIHtcclxuICAgICAgICAgICAgc3RtdC5wYXJhbWV0ZXIoJ2tlZ19pZCcsIFRZUEVTLkludCwga2VnSWQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgcmVzdWx0cyA9IGF3YWl0IHN0bXQuZXhlY3V0ZUltbWVkaWF0ZSgpO1xyXG4gICAgICAgIGxldCBvdXRwdXQgPSByZXN1bHRzLm1hcCgocm93KSA9PiB7IFxyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgS2VnSWQ6IHJvdy5JZCxcclxuICAgICAgICAgICAgICAgIE5hbWU6IHJvdy5OYW1lLFxyXG4gICAgICAgICAgICAgICAgQnJld2VyeTogcm93LkJyZXdlcnksXHJcbiAgICAgICAgICAgICAgICBCZWVyVHlwZTogcm93LkJlZXJUeXBlLFxyXG4gICAgICAgICAgICAgICAgQUJWOiByb3cuQUJWLFxyXG4gICAgICAgICAgICAgICAgSUJVOiByb3cuSUJVLFxyXG4gICAgICAgICAgICAgICAgQmVlckRlc2NyaXB0aW9uOiByb3cuQmVlckRlc2NyaXB0aW9uLFxyXG4gICAgICAgICAgICAgICAgVW50YXBwZElkOiByb3cuVW50YXBwZElkLFxyXG4gICAgICAgICAgICAgICAgaW1hZ2VQYXRoOiByb3cuaW1hZ2VQYXRoXHJcbiAgICAgICAgICAgIH19KTtcclxuICAgICAgICBpZiAoa2VnSWQpIHtcclxuICAgICAgICAgICAgaWYgKG91dHB1dC5sZW5ndGggPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG91dHB1dEZ1bmMoe2NvZGU6IDQwNCwgbXNnOiAnU3BlY2lmaWVkIGtlZyBjb3VsZCBub3QgYmUgZm91bmQnfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gb3V0cHV0RnVuYyh7Y29kZTogMjAwLCBtc2c6IG91dHB1dFswXX0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gb3V0cHV0RnVuYyh7IGNvZGU6IDIwMCwgbXNnOiBvdXRwdXR9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBjYXRjaCAoZXgpIHtcclxuICAgICAgICByZXR1cm4gb3V0cHV0RnVuYyh7Y29kZTogNTAwLCBtc2c6J0ludGVybmFsIEVycm9yOiAnICsgZXh9KTtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHBvc3ROZXdLZWcoYm9keTogYW55LCBvdXRwdXQ6IChyZXNwOmFueSkgPT4gZXhwcmVzcy5SZXNwb25zZSkge1xyXG4gICAgdHJ5IHtcclxuICAgICAgICAvLyBJZiB0aGV5J3ZlIHN1cHBsaWVkIGFuIFVudGFwcGVkIGJlZXIgaWQsIGxvb2sgdGhpcyB1cCBub3dcclxuICAgICAgICBpZiAoYm9keS5VbnRhcHBkSWQgJiYgdW50YXBwZC5pc0ludGVncmF0aW9uRW5hYmxlZCgpKSB7XHJcbiAgICAgICAgICAgIHZhciBiZWVySW5mbyA9IGF3YWl0IHVudGFwcGQuZ2V0QmVlckluZm8oYm9keS5VbnRhcHBkSWQpO1xyXG4gICAgICAgICAgICBib2R5Lk5hbWUgPSBiZWVySW5mby5iZWVyX25hbWU7XHJcbiAgICAgICAgICAgIGJvZHkuQnJld2VyeSA9IGJlZXJJbmZvLmJyZXdlcnlfbmFtZTtcclxuICAgICAgICAgICAgYm9keS5CZWVyVHlwZSA9IGJlZXJJbmZvLmJlZXJfc3R5bGU7XHJcbiAgICAgICAgICAgIGJvZHkuQUJWID0gYmVlckluZm8uYmVlcl9hYnY7XHJcbiAgICAgICAgICAgIGJvZHkuSUJVID0gYmVlckluZm8uYmVlcl9pYnU7XHJcbiAgICAgICAgICAgIGJvZHkuQmVlckRlc2NyaXB0aW9uID0gYmVlckluZm8uYmVlcl9kZXNjcmlwdGlvbjtcclxuICAgICAgICAgICAgYm9keS5pbWFnZVBhdGggPSBiZWVySW5mby5iZWVyX2xhYmVsX2ltYWdlO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgc3FsU3RhdGVtZW50ID0gXCJJTlNFUlQgSU5UTyBEaW1LZWcgXCIgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBcIihOYW1lLCBCcmV3ZXJ5LCBCZWVyVHlwZSwgQUJWLCBJQlUsIEJlZXJEZXNjcmlwdGlvbiwgVW50YXBwZElkLCBpbWFnZVBhdGgpIFwiICsgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiVkFMVUVTIChAbmFtZSwgQGJyZXdlcnksIEBiZWVyVHlwZSwgQGFidiwgQGlidSwgQGJlZXJEZXNjcmlwdGlvbiwgQHVudGFwcGRJZCwgQGltYWdlUGF0aCk7IFwiICtcclxuICAgICAgICAgICAgICAgICAgICAgICAgXCJTRUxFQ1QgU0NPUEVfSURFTlRJVFkoKSBhcyBJZDtcIlxyXG4gICAgICAgIHZhciByZXN1bHRzID0gYXdhaXQgdGRzLmRlZmF1bHQuc3FsKHNxbFN0YXRlbWVudClcclxuICAgICAgICAgICAgLnBhcmFtZXRlcihcIm5hbWVcIiwgVFlQRVMuTlZhckNoYXIsIGJvZHkuTmFtZSlcclxuICAgICAgICAgICAgLnBhcmFtZXRlcihcImJyZXdlcnlcIiwgVFlQRVMuTlZhckNoYXIsIGJvZHkuQnJld2VyeSlcclxuICAgICAgICAgICAgLnBhcmFtZXRlcihcImJlZXJUeXBlXCIsIFRZUEVTLk5WYXJDaGFyLCBib2R5LkJlZXJUeXBlKVxyXG4gICAgICAgICAgICAucGFyYW1ldGVyKFwiYWJ2XCIsIFRZUEVTLkRlY2ltYWwsIGJvZHkuQUJWLCB7c2NhbGU6MX0pXHJcbiAgICAgICAgICAgIC5wYXJhbWV0ZXIoXCJpYnVcIiwgVFlQRVMuSW50LCBib2R5LklCVSlcclxuICAgICAgICAgICAgLnBhcmFtZXRlcihcImJlZXJEZXNjcmlwdGlvblwiLCBUWVBFUy5OVmFyQ2hhciwgYm9keS5CZWVyRGVzY3JpcHRpb24pXHJcbiAgICAgICAgICAgIC5wYXJhbWV0ZXIoXCJ1bnRhcHBkSWRcIiwgVFlQRVMuSW50LCBib2R5LlVudGFwcGRJZClcclxuICAgICAgICAgICAgLnBhcmFtZXRlcihcImltYWdlUGF0aFwiLCBUWVBFUy5OVmFyQ2hhciwgYm9keS5pbWFnZVBhdGgpXHJcbiAgICAgICAgICAgIC5leGVjdXRlSW1tZWRpYXRlKCk7XHJcbiAgICAgICAgZ2V0S2VnKHJlc3VsdHNbMF0uSWQsIG91dHB1dCk7XHJcbiAgICB9XHJcbiAgICBjYXRjaCAoZXgpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKCdrZWdDb250cm9sbGVyLnBvc3ROZXdLZWcgZXJyb3I6ICcgKyBleCk7XHJcbiAgICAgICAgb3V0cHV0KHtjb2RlOiA1MDAsIG1zZzogJ0ludGVybmFsIGVycm9yOiAnICsgZXh9KTtcclxuICAgIH1cclxufVxyXG4iXX0=
