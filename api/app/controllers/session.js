"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const tds = require("../utils/tds-promises");
const tedious_1 = require("tedious");
const queryExpression = require("../utils/query_expression");
const kegController = require("./kegController");
const untappd = require("../utils/untappd");
function getSessions(sessionId, queryParams, output) {
    return __awaiter(this, void 0, void 0, function* () {
        try {
            let sessions = yield getSessions_internal(sessionId, queryParams);
            if (sessionId != null) {
                if (sessions.length == 0) {
                    output({ code: 404, msg: 'Specified session not found!' });
                }
                else {
                    output({ code: 200, msg: sessions[0] });
                }
            }
            else {
                output({ code: 200, msg: sessions });
            }
        }
        catch (ex) {
            output({ code: 500, msg: 'Internal Error: ' + ex });
        }
    });
}
exports.getSessions = getSessions;
function getSessions_internal(sessionId, queryParams) {
    return __awaiter(this, void 0, void 0, function* () {
        try {
            queryParams.mapping = {
                'pourtime': { sqlName: 'PourDateTime', dataType: tedious_1.TYPES.DateTime2 },
                'pouramount': { sqlName: 'PourAmountInML', dataType: tedious_1.TYPES.Int },
                'activityid': { sqlName: 'd.Id', dataType: tedious_1.TYPES.Int }
            };
            queryParams.ordering = [
                'pourtime',
                'pouramount'
            ];
            queryParams.limit = 'count';
            var sqlStatement = `SELECT ${queryParams.getSqlLimitClause()} d.Id as SessionId, k.Name as BeerName, * ` +
                `FROM FactDrinkers d INNER JOIN DimKeg k ON d.KegId = k.Id ` +
                `    INNER JOIN HC01Person p ON d.PersonnelNumber = p.PersonnelNumber `;
            if (sessionId != null || queryParams.isAnyFilter()) {
                sqlStatement += "WHERE ";
                if (sessionId != null) {
                    sqlStatement += "d.Id = @sessionId";
                }
                else {
                    sqlStatement += queryParams.getSqlFilterPredicates();
                }
            }
            if (queryParams.isAnyOrdering()) {
                sqlStatement += queryParams.getSqlOrderByClauses();
            }
            else {
                sqlStatement += " ORDER BY d.PourDateTime DESC";
            }
            var stmt = tds.default.sql(sqlStatement);
            if (sessionId != null) {
                stmt.parameter('sessionId', tedious_1.TYPES.Int, sessionId);
            }
            if (queryParams.isAnyFilter()) {
                queryParams.addRequestParameters(stmt);
            }
            let results = yield stmt.executeImmediate();
            return results.map(row => {
                return {
                    SessionId: row.SessionId,
                    PourTime: row.PourDateTime,
                    PourAmount: row.PourAmountInML,
                    BeerName: row.BeerName,
                    Brewery: row.Brewery,
                    BeerType: row.BeerType,
                    ABV: row.ABV,
                    IBU: row.IBU,
                    BeerDescription: row.BeerDescription,
                    UntappdId: row.UntappdId,
                    BeerImagePath: row.imagePath,
                    PersonnelNumber: row.PersonnelNumber,
                    Alias: row.EmailName,
                    FullName: row.FullName
                };
            });
        }
        catch (ex) {
            return Promise.reject(ex);
        }
    });
}
function postNewSession(body, output) {
    return __awaiter(this, void 0, void 0, function* () {
        var tapsInfo;
        try {
            tapsInfo = yield kegController.getCurrentKeg_Internal(null);
        }
        catch (ex) {
            return output({ code: 500, msg: "Failed to update session activity: " + ex });
        }
        new tds.TdsConnection().transaction((connection) => __awaiter(this, void 0, void 0, function* () {
            var sqlStatement = "INSERT INTO FactDrinkers (PourDateTime, PersonnelNumber, TapId, KegId, PourAmountInML) " +
                "VALUES (@pourTime, @personnelNumber, @tapId, @kegId, @pourAmount); " +
                "SELECT Id, KegId, TapId, PourAmountInML FROM FactDrinkers WHERE Id = SCOPE_IDENTITY();";
            var insertDrinkers = yield connection.sql(sqlStatement)
                .parameter('pourTime', tedious_1.TYPES.DateTime2, null)
                .parameter('personnelNumber', tedious_1.TYPES.Int, null)
                .parameter('tapId', tedious_1.TYPES.Int, null)
                .parameter('kegId', tedious_1.TYPES.Int, null)
                .parameter('pourAmount', tedious_1.TYPES.Int, null)
                .prepare();
            var newActivities = yield tapsInfo
                .filter(tapInfo => body.Taps[tapInfo.TapId.toString()] != null &&
                body.Taps[tapInfo.TapId.toString()].amount > 20)
                .mapAsync((tapInfo) => __awaiter(this, void 0, void 0, function* () {
                let newActivity = yield insertDrinkers.execute(false, false, {
                    pourTime: new Date(body.sessionTime),
                    personnelNumber: body.personnelNumber,
                    tapId: tapInfo.TapId,
                    kegId: tapInfo.KegId,
                    pourAmount: parseInt(body.Taps[tapInfo.TapId.toString()].amount)
                });
                return newActivity[0];
            }));
            sqlStatement = "UPDATE FactKegInstall " +
                "SET currentVolumeInML = currentVolumeInML - @pourAmount " +
                "WHERE KegId = @kegId AND isCurrent = 1";
            var updateKegVolume = yield connection.sql(sqlStatement)
                .parameter('pourAmount', tedious_1.TYPES.Decimal, 0.0)
                .parameter('kegId', tedious_1.TYPES.Int, 0)
                .prepare();
            yield newActivities.forEachAsync((newActivity) => __awaiter(this, void 0, void 0, function* () {
                yield updateKegVolume.execute(false, false, {
                    kegId: newActivity.KegId,
                    pourAmount: newActivity.PourAmountInML
                });
            }));
            var retval = newActivities.map(activity => {
                return {
                    ActivityId: activity.Id,
                    KegId: activity.KegId,
                    TapId: activity.TapId,
                    amount: activity.PourAmountInML
                };
            });
            output({ code: 200, msg: retval });
            return retval;
        }), (results) => {
            if (untappd.isIntegrationEnabled()) {
                postUntappdActivity(results)
                    .catch(reason => {
                    console.error(reason);
                });
            }
        }, (ex) => output({ code: 500, msg: "Failed to update session activity: " + ex }));
    });
}
exports.postNewSession = postNewSession;
function postUntappdActivity(activities) {
    if (!untappd.isIntegrationEnabled()) {
        return Promise.resolve();
    }
    return new Promise((resolve, reject) => __awaiter(this, void 0, void 0, function* () {
        try {
            let sessions = yield getSessions_internal(null, new queryExpression.QueryExpression({ activityid_in: activities.map(activity => activity.ActivityId).join(',') }));
            untappd.postSessionCheckin(sessions);
        }
        catch (ex) {
            reject(ex);
        }
    }));
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9jb250cm9sbGVycy9zZXNzaW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFFQSw2Q0FBOEM7QUFDOUMscUNBQThCO0FBQzlCLDZEQUE4RDtBQUM5RCxpREFBa0Q7QUFDbEQsNENBQTZDO0FBRzdDLHFCQUFrQyxTQUFpQixFQUFFLFdBQTRDLEVBQUUsTUFBc0M7O1FBQ3JJLElBQUksQ0FBQztZQUNELElBQUksUUFBUSxHQUFHLE1BQU0sb0JBQW9CLENBQUMsU0FBUyxFQUFFLFdBQVcsQ0FBQyxDQUFDO1lBQ2xFLEVBQUUsQ0FBQyxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUNwQixFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3ZCLE1BQU0sQ0FBQyxFQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFDLDhCQUE4QixFQUFDLENBQUMsQ0FBQztnQkFDNUQsQ0FBQztnQkFDRCxJQUFJLENBQUMsQ0FBQztvQkFDRixNQUFNLENBQUMsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUM1QyxDQUFDO1lBQ0wsQ0FBQztZQUNELElBQUksQ0FBQyxDQUFDO2dCQUNGLE1BQU0sQ0FBQyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBQyxDQUFDLENBQUM7WUFDeEMsQ0FBQztRQUNMLENBQUM7UUFDRCxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ1IsTUFBTSxDQUFDLEVBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUMsa0JBQWtCLEdBQUcsRUFBRSxFQUFDLENBQUMsQ0FBQztRQUNyRCxDQUFDO0lBQ0wsQ0FBQztDQUFBO0FBbEJELGtDQWtCQztBQUVELDhCQUFvQyxTQUFpQixFQUFFLFdBQTRD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QUMsQ0FBQyxDQUFDO1FBQ2xDLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDN0IsQ0FBQztJQUNELE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBTyxDQUFPLE9BQU8sRUFBRSxNQUFNO1FBQzNDLElBQUksQ0FBQztZQUNELElBQUksUUFBUSxHQUFHLE1BQU0sb0JBQW9CLENBQUMsSUFBSSxFQUFFLElBQUksZUFBZSxDQUFDLGVBQWUsQ0FBQyxFQUFDLGFBQWEsRUFBRSxVQUFVLENBQUMsR0FBRyxDQUFDLFFBQVEsSUFBSSxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2pLLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN6QyxDQUFDO1FBQ0QsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNSLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNmLENBQUM7SUFDTCxDQUFDLENBQUEsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyIsImZpbGUiOiJhcHAvY29udHJvbGxlcnMvc2Vzc2lvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5pbXBvcnQgZXhwcmVzcyA9IHJlcXVpcmUoJ2V4cHJlc3MnKTtcclxuaW1wb3J0IHRkcyA9IHJlcXVpcmUoJy4uL3V0aWxzL3Rkcy1wcm9taXNlcycpO1xyXG5pbXBvcnQge1RZUEVTfSBmcm9tICd0ZWRpb3VzJztcclxuaW1wb3J0IHF1ZXJ5RXhwcmVzc2lvbiA9IHJlcXVpcmUoJy4uL3V0aWxzL3F1ZXJ5X2V4cHJlc3Npb24nKTtcclxuaW1wb3J0IGtlZ0NvbnRyb2xsZXIgPSByZXF1aXJlKCcuL2tlZ0NvbnRyb2xsZXInKTtcclxuaW1wb3J0IHVudGFwcGQgPSByZXF1aXJlKCcuLi91dGlscy91bnRhcHBkJyk7XHJcbmltcG9ydCB7U2Vzc2lvbn0gZnJvbSAnLi4vbW9kZWxzL1Nlc3Npb24nO1xyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFNlc3Npb25zKHNlc3Npb25JZDogbnVtYmVyLCBxdWVyeVBhcmFtczogcXVlcnlFeHByZXNzaW9uLlF1ZXJ5RXhwcmVzc2lvbiwgb3V0cHV0OiAocmVzcDphbnkpID0+IGV4cHJlc3MuUmVzcG9uc2UpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgbGV0IHNlc3Npb25zID0gYXdhaXQgZ2V0U2Vzc2lvbnNfaW50ZXJuYWwoc2Vzc2lvbklkLCBxdWVyeVBhcmFtcyk7XHJcbiAgICAgICAgaWYgKHNlc3Npb25JZCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIGlmIChzZXNzaW9ucy5sZW5ndGggPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgb3V0cHV0KHtjb2RlOiA0MDQsIG1zZzonU3BlY2lmaWVkIHNlc3Npb24gbm90IGZvdW5kISd9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIG91dHB1dCh7IGNvZGU6IDIwMCwgbXNnOiBzZXNzaW9uc1swXSB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgb3V0cHV0KHsgY29kZTogMjAwLCBtc2c6IHNlc3Npb25zfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgY2F0Y2ggKGV4KSB7XHJcbiAgICAgICAgb3V0cHV0KHtjb2RlOiA1MDAsIG1zZzonSW50ZXJuYWwgRXJyb3I6ICcgKyBleH0pO1xyXG4gICAgfVxyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBnZXRTZXNzaW9uc19pbnRlcm5hbChzZXNzaW9uSWQ6IG51bWJlciwgcXVlcnlQYXJhbXM6IHF1ZXJ5RXhwcmVzc2lvbi5RdWVyeUV4cHJlc3Npb24pOiBQcm9taXNlPFNlc3Npb25bXT4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgICBxdWVyeVBhcmFtcy5tYXBwaW5nID0ge1xyXG4gICAgICAgICAgICAncG91cnRpbWUnOiB7c3FsTmFtZTonUG91ckRhdGVUaW1lJywgZGF0YVR5cGU6IFRZUEVTLkRhdGVUaW1lMn0sXHJcbiAgICAgICAgICAgICdwb3VyYW1vdW50Jzoge3NxbE5hbWU6J1BvdXJBbW91bnRJbk1MJywgZGF0YVR5cGU6IFRZUEVTLkludH0sXHJcbiAgICAgICAgICAgICdhY3Rpdml0eWlkJzoge3NxbE5hbWU6J2QuSWQnLCBkYXRhVHlwZTogVFlQRVMuSW50fVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgcXVlcnlQYXJhbXMub3JkZXJpbmcgPSBbXHJcbiAgICAgICAgICAgICdwb3VydGltZScsXHJcbiAgICAgICAgICAgICdwb3VyYW1vdW50J1xyXG4gICAgICAgIF07XHJcbiAgICAgICAgcXVlcnlQYXJhbXMubGltaXQgPSAnY291bnQnO1xyXG5cclxuICAgICAgICB2YXIgc3FsU3RhdGVtZW50ID0gYFNFTEVDVCAke3F1ZXJ5UGFyYW1zLmdldFNxbExpbWl0Q2xhdXNlKCl9IGQuSWQgYXMgU2Vzc2lvbklkLCBrLk5hbWUgYXMgQmVlck5hbWUsICogYCArIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBgRlJPTSBGYWN0RHJpbmtlcnMgZCBJTk5FUiBKT0lOIERpbUtlZyBrIE9OIGQuS2VnSWQgPSBrLklkIGAgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBgICAgIElOTkVSIEpPSU4gSEMwMVBlcnNvbiBwIE9OIGQuUGVyc29ubmVsTnVtYmVyID0gcC5QZXJzb25uZWxOdW1iZXIgYDtcclxuICAgICAgICBpZiAoc2Vzc2lvbklkICE9IG51bGwgfHwgcXVlcnlQYXJhbXMuaXNBbnlGaWx0ZXIoKSkge1xyXG4gICAgICAgICAgICBzcWxTdGF0ZW1lbnQgKz0gXCJXSEVSRSBcIjtcclxuICAgICAgICAgICAgaWYgKHNlc3Npb25JZCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBzcWxTdGF0ZW1lbnQgKz0gXCJkLklkID0gQHNlc3Npb25JZFwiXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBzcWxTdGF0ZW1lbnQgKz0gcXVlcnlQYXJhbXMuZ2V0U3FsRmlsdGVyUHJlZGljYXRlcygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChxdWVyeVBhcmFtcy5pc0FueU9yZGVyaW5nKCkpIHtcclxuICAgICAgICAgICAgc3FsU3RhdGVtZW50ICs9IHF1ZXJ5UGFyYW1zLmdldFNxbE9yZGVyQnlDbGF1c2VzKClcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHNxbFN0YXRlbWVudCArPSBcIiBPUkRFUiBCWSBkLlBvdXJEYXRlVGltZSBERVNDXCI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBzdG10ID0gdGRzLmRlZmF1bHQuc3FsKHNxbFN0YXRlbWVudCk7XHJcbiAgICAgICAgaWYgKHNlc3Npb25JZCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIHN0bXQucGFyYW1ldGVyKCdzZXNzaW9uSWQnLCBUWVBFUy5JbnQsIHNlc3Npb25JZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChxdWVyeVBhcmFtcy5pc0FueUZpbHRlcigpKSB7XHJcbiAgICAgICAgICAgIHF1ZXJ5UGFyYW1zLmFkZFJlcXVlc3RQYXJhbWV0ZXJzKHN0bXQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgcmVzdWx0cyA9IGF3YWl0IHN0bXQuZXhlY3V0ZUltbWVkaWF0ZSgpO1xyXG4gICAgICAgIHJldHVybiByZXN1bHRzLm1hcChyb3cgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgU2Vzc2lvbklkOiByb3cuU2Vzc2lvbklkLFxyXG4gICAgICAgICAgICAgICAgUG91clRpbWU6IHJvdy5Qb3VyRGF0ZVRpbWUsXHJcbiAgICAgICAgICAgICAgICBQb3VyQW1vdW50OiByb3cuUG91ckFtb3VudEluTUwsXHJcbiAgICAgICAgICAgICAgICBCZWVyTmFtZTogcm93LkJlZXJOYW1lLFxyXG4gICAgICAgICAgICAgICAgQnJld2VyeTogcm93LkJyZXdlcnksXHJcbiAgICAgICAgICAgICAgICBCZWVyVHlwZTogcm93LkJlZXJUeXBlLFxyXG4gICAgICAgICAgICAgICAgQUJWOiByb3cuQUJWLFxyXG4gICAgICAgICAgICAgICAgSUJVOiByb3cuSUJVLFxyXG4gICAgICAgICAgICAgICAgQmVlckRlc2NyaXB0aW9uOiByb3cuQmVlckRlc2NyaXB0aW9uLFxyXG4gICAgICAgICAgICAgICAgVW50YXBwZElkOiByb3cuVW50YXBwZElkLFxyXG4gICAgICAgICAgICAgICAgQmVlckltYWdlUGF0aDogcm93LmltYWdlUGF0aCxcclxuICAgICAgICAgICAgICAgIFBlcnNvbm5lbE51bWJlcjogcm93LlBlcnNvbm5lbE51bWJlcixcclxuICAgICAgICAgICAgICAgIEFsaWFzOiByb3cuRW1haWxOYW1lLFxyXG4gICAgICAgICAgICAgICAgRnVsbE5hbWU6IHJvdy5GdWxsTmFtZVxyXG4gICAgICAgICAgICB9fSk7XHJcbiAgICB9XHJcbiAgICBjYXRjaCAoZXgpIHtcclxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXgpO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcG9zdE5ld1Nlc3Npb24oYm9keTogYW55LCBvdXRwdXQ6IChyZXNwOmFueSkgPT4gZXhwcmVzcy5SZXNwb25zZSkge1xyXG4gICAgdmFyIHRhcHNJbmZvOiBhbnlbXTtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgLy8gTG9va3VwIG91ciBjdXJyZW50IGtlZyBpbmZvXHJcbiAgICAgICAgdGFwc0luZm8gPSBhd2FpdCBrZWdDb250cm9sbGVyLmdldEN1cnJlbnRLZWdfSW50ZXJuYWwobnVsbCk7XHJcbiAgICB9XHJcbiAgICBjYXRjaCAoZXgpIHtcclxuICAgICAgICByZXR1cm4gb3V0cHV0KHtjb2RlOjUwMCwgbXNnOiBcIkZhaWxlZCB0byB1cGRhdGUgc2Vzc2lvbiBhY3Rpdml0eTogXCIgKyBleH0pO1xyXG4gICAgfVxyXG4gICAgbmV3IHRkcy5UZHNDb25uZWN0aW9uKCkudHJhbnNhY3Rpb24oYXN5bmMgKGNvbm5lY3Rpb246IHRkcy5UZHNDb25uZWN0aW9uKSA9PiB7XHJcbiAgICAgICAgLy8gQWRkIGpvdXJuYWwgZW50cmllcyBpbnRvIHRoZSBhY3Rpdml0aWVzIHRhYmxlXHJcbiAgICAgICAgdmFyIHNxbFN0YXRlbWVudCA9IFwiSU5TRVJUIElOVE8gRmFjdERyaW5rZXJzIChQb3VyRGF0ZVRpbWUsIFBlcnNvbm5lbE51bWJlciwgVGFwSWQsIEtlZ0lkLCBQb3VyQW1vdW50SW5NTCkgXCIgKyBcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiVkFMVUVTIChAcG91clRpbWUsIEBwZXJzb25uZWxOdW1iZXIsIEB0YXBJZCwgQGtlZ0lkLCBAcG91ckFtb3VudCk7IFwiICtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiU0VMRUNUIElkLCBLZWdJZCwgVGFwSWQsIFBvdXJBbW91bnRJbk1MIEZST00gRmFjdERyaW5rZXJzIFdIRVJFIElkID0gU0NPUEVfSURFTlRJVFkoKTtcIjtcclxuICAgICAgICB2YXIgaW5zZXJ0RHJpbmtlcnMgPSBhd2FpdCBjb25uZWN0aW9uLnNxbChzcWxTdGF0ZW1lbnQpXHJcbiAgICAgICAgICAgIC5wYXJhbWV0ZXIoJ3BvdXJUaW1lJywgVFlQRVMuRGF0ZVRpbWUyLCBudWxsKVxyXG4gICAgICAgICAgICAucGFyYW1ldGVyKCdwZXJzb25uZWxOdW1iZXInLCBUWVBFUy5JbnQsIG51bGwpXHJcbiAgICAgICAgICAgIC5wYXJhbWV0ZXIoJ3RhcElkJywgVFlQRVMuSW50LCBudWxsKVxyXG4gICAgICAgICAgICAucGFyYW1ldGVyKCdrZWdJZCcsIFRZUEVTLkludCwgbnVsbClcclxuICAgICAgICAgICAgLnBhcmFtZXRlcigncG91ckFtb3VudCcsIFRZUEVTLkludCwgbnVsbClcclxuICAgICAgICAgICAgLnByZXBhcmUoKTtcclxuICAgICAgICB2YXIgbmV3QWN0aXZpdGllcyA9IGF3YWl0IHRhcHNJbmZvXHJcbiAgICAgICAgICAgIC5maWx0ZXIodGFwSW5mbyA9PiBib2R5LlRhcHNbdGFwSW5mby5UYXBJZC50b1N0cmluZygpXSAhPSBudWxsICYmXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9keS5UYXBzW3RhcEluZm8uVGFwSWQudG9TdHJpbmcoKV0uYW1vdW50ID4gMjApXHJcbiAgICAgICAgICAgIC5tYXBBc3luYyhhc3luYyB0YXBJbmZvID0+IHtcclxuICAgICAgICAgICAgICAgIC8vIEltcG9ydGFudCB3ZSBhd2FpdCBoZXJlIGFzIHdlIGNhbid0IGhhdmUgbXVsdGlwbGUgc3RhdGVtZW50cyBhY3Rpdml0eSBhdCBvbmNlXHJcbiAgICAgICAgICAgICAgICBsZXQgbmV3QWN0aXZpdHkgPSBhd2FpdCBpbnNlcnREcmlua2Vycy5leGVjdXRlKGZhbHNlLCBmYWxzZSwge1xyXG4gICAgICAgICAgICAgICAgICAgIHBvdXJUaW1lOiBuZXcgRGF0ZShib2R5LnNlc3Npb25UaW1lKSwgXHJcbiAgICAgICAgICAgICAgICAgICAgcGVyc29ubmVsTnVtYmVyOiBib2R5LnBlcnNvbm5lbE51bWJlcixcclxuICAgICAgICAgICAgICAgICAgICB0YXBJZDogdGFwSW5mby5UYXBJZCxcclxuICAgICAgICAgICAgICAgICAgICBrZWdJZDogdGFwSW5mby5LZWdJZCxcclxuICAgICAgICAgICAgICAgICAgICBwb3VyQW1vdW50OiBwYXJzZUludChib2R5LlRhcHNbdGFwSW5mby5UYXBJZC50b1N0cmluZygpXS5hbW91bnQpXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBuZXdBY3Rpdml0eVswXTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIE5vdyBkZWNyZW1lbnQgdGhlIGF2YWlsYWJsZSB2b2x1bWUgaW4gZWFjaCBvZiBvdXIga2Vnc1xyXG4gICAgICAgIHNxbFN0YXRlbWVudCA9IFwiVVBEQVRFIEZhY3RLZWdJbnN0YWxsIFwiICsgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiU0VUIGN1cnJlbnRWb2x1bWVJbk1MID0gY3VycmVudFZvbHVtZUluTUwgLSBAcG91ckFtb3VudCBcIiArIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBcIldIRVJFIEtlZ0lkID0gQGtlZ0lkIEFORCBpc0N1cnJlbnQgPSAxXCI7XHJcbiAgICAgICAgdmFyIHVwZGF0ZUtlZ1ZvbHVtZSA9IGF3YWl0IGNvbm5lY3Rpb24uc3FsKHNxbFN0YXRlbWVudClcclxuICAgICAgICAgICAgLnBhcmFtZXRlcigncG91ckFtb3VudCcsIFRZUEVTLkRlY2ltYWwsIDAuMClcclxuICAgICAgICAgICAgLnBhcmFtZXRlcigna2VnSWQnLCBUWVBFUy5JbnQsIDApXHJcbiAgICAgICAgICAgIC5wcmVwYXJlKCk7XHJcbiAgICAgICAgYXdhaXQgbmV3QWN0aXZpdGllcy5mb3JFYWNoQXN5bmMoYXN5bmMgbmV3QWN0aXZpdHkgPT4ge1xyXG4gICAgICAgICAgICBhd2FpdCB1cGRhdGVLZWdWb2x1bWUuZXhlY3V0ZShmYWxzZSwgZmFsc2UsIHtcclxuICAgICAgICAgICAgICAgIGtlZ0lkOiBuZXdBY3Rpdml0eS5LZWdJZCxcclxuICAgICAgICAgICAgICAgIHBvdXJBbW91bnQ6IG5ld0FjdGl2aXR5LlBvdXJBbW91bnRJbk1MXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHZhciByZXR2YWwgPSBuZXdBY3Rpdml0aWVzLm1hcChhY3Rpdml0eSA9PiB7IFxyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgQWN0aXZpdHlJZDogYWN0aXZpdHkuSWQsIFxyXG4gICAgICAgICAgICAgICAgS2VnSWQ6IGFjdGl2aXR5LktlZ0lkLCBcclxuICAgICAgICAgICAgICAgIFRhcElkOiBhY3Rpdml0eS5UYXBJZCwgXHJcbiAgICAgICAgICAgICAgICBhbW91bnQ6IGFjdGl2aXR5LlBvdXJBbW91bnRJbk1MXHJcbiAgICAgICAgICAgIH07IFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIG91dHB1dCh7Y29kZTogMjAwLCBtc2c6IHJldHZhbH0pO1xyXG4gICAgICAgIHJldHVybiByZXR2YWw7XHJcbiAgICB9LCBcclxuICAgIChyZXN1bHRzKSA9PiB7XHJcbiAgICAgICAgLy8gQXN5bmNocm9ub3VzbHkgcG9zdCBjaGVja2luIHRvIFVudGFwcGRJZFxyXG4gICAgICAgIGlmICh1bnRhcHBkLmlzSW50ZWdyYXRpb25FbmFibGVkKCkpIHtcclxuICAgICAgICAgICAgcG9zdFVudGFwcGRBY3Rpdml0eShyZXN1bHRzKVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKHJlYXNvbiA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihyZWFzb24pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSwgXHJcbiAgICAoZXg6IEVycm9yKSA9PiBvdXRwdXQoe2NvZGU6NTAwLCBtc2c6IFwiRmFpbGVkIHRvIHVwZGF0ZSBzZXNzaW9uIGFjdGl2aXR5OiBcIiArIGV4fSkpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBwb3N0VW50YXBwZEFjdGl2aXR5KGFjdGl2aXRpZXM6IGFueVtdKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBpZiAoIXVudGFwcGQuaXNJbnRlZ3JhdGlvbkVuYWJsZWQoKSkge1xyXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcclxuICAgIH1cclxuICAgIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPihhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgbGV0IHNlc3Npb25zID0gYXdhaXQgZ2V0U2Vzc2lvbnNfaW50ZXJuYWwobnVsbCwgbmV3IHF1ZXJ5RXhwcmVzc2lvbi5RdWVyeUV4cHJlc3Npb24oe2FjdGl2aXR5aWRfaW46IGFjdGl2aXRpZXMubWFwKGFjdGl2aXR5ID0+IGFjdGl2aXR5LkFjdGl2aXR5SWQpLmpvaW4oJywnKX0pKTtcclxuICAgICAgICAgICAgdW50YXBwZC5wb3N0U2Vzc2lvbkNoZWNraW4oc2Vzc2lvbnMpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoZXgpIHtcclxuICAgICAgICAgICAgcmVqZWN0KGV4KTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufSJdfQ==
